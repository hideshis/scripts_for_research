<!DOCTYPE html>
<html>
<head>
  <title>CachingHttpClient.java</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../../../../../../coverage.css'/>
  <link rel='shortcut icon' type='image/png' href='../../../../../../logo.png'/>
  <script type='text/javascript' src='../../../../../../coverage.js'></script>
  <script type='text/javascript' src='../../../../../../prettify.js'></script>
</head>
<body onload='prettyPrint()'>
  <table cellpadding='0' cellspacing='1'>
    <caption>httpclient-cache/src/main/java-deprecated/org/apache/http/impl/client/cache/CachingHttpClient.java</caption>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>/*
 * ====================================================================
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 * ====================================================================
 *
 * This software consists of voluntary contributions made by many
 * individuals on behalf of the Apache Software Foundation.  For more
 * information on the Apache Software Foundation, please see
 * &lt;http://www.apache.org/>.
 *
 */</div><span>/*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>27</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>package org.apache.http.impl.client.cache;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td><pre class='imports prettyprint' onclick='showHideLines(this)'><div>import java.io.IOException;
import java.lang.reflect.UndeclaredThrowableException;
import java.net.URI;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicLong;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.http.Header;
import org.apache.http.HeaderElement;
import org.apache.http.HttpEntity;
import org.apache.http.HttpHost;
import org.apache.http.HttpMessage;
import org.apache.http.HttpRequest;
import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.HttpVersion;
import org.apache.http.ProtocolException;
import org.apache.http.ProtocolVersion;
import org.apache.http.RequestLine;
import org.apache.http.annotation.ThreadSafe;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.cache.CacheResponseStatus;
import org.apache.http.client.cache.HeaderConstants;
import org.apache.http.client.cache.HttpCacheEntry;
import org.apache.http.client.cache.HttpCacheStorage;
import org.apache.http.client.cache.ResourceFactory;
import org.apache.http.client.methods.HttpRequestWrapper;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.conn.ClientConnectionManager;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.impl.cookie.DateParseException;
import org.apache.http.impl.cookie.DateUtils;
import org.apache.http.message.BasicHttpResponse;
import org.apache.http.params.HttpParams;
import org.apache.http.protocol.ExecutionContext;
import org.apache.http.protocol.HTTP;
import org.apache.http.protocol.HttpContext;
import org.apache.http.util.Args;
import org.apache.http.util.VersionInfo;
</div><span>import ...</span></pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>/**
 * &lt;p>
 * The {@link CachingHttpClient} is meant to be a drop-in replacement for
 * a {@link DefaultHttpClient} that transparently adds client-side caching.
 * The current implementation is conditionally compliant with HTTP/1.1
 * (meaning all the MUST and MUST NOTs are obeyed), although quite a lot,
 * though not all, of the SHOULDs and SHOULD NOTs are obeyed too. Generally
 * speaking, you construct a {@code CachingHttpClient} by providing a
 * "backend" {@link HttpClient} used for making actual network requests and
 * provide an {@link HttpCacheStorage} instance to use for holding onto
 * cached responses. Additional configuration options can be provided by
 * passing in a {@link CacheConfig}. Note that all of the usual client
 * related configuration you want to do vis-a-vis timeouts and connection
 * pools should be done on this backend client before constructing a {@code
 * CachingHttpClient} from it.
 * &lt;/p>
 *
 * &lt;p>
 * Generally speaking, the {@code CachingHttpClient} is implemented as a
 * &lt;a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator&lt;/a>
 * of the backend client; for any incoming request it attempts to satisfy
 * it from the cache, but if it can't, or if it needs to revalidate a stale
 * cache entry, it will use the backend client to make an actual request.
 * However, a proper HTTP/1.1 cache won't change the semantics of a request
 * and response; in particular, if you issue an unconditional request you
 * will get a full response (although it may be served to you from the cache,
 * or the cache may make a conditional request on your behalf to the origin).
 * This notion of "semantic transparency" means you should be able to drop
 * a {@link CachingHttpClient} into an existing application without breaking
 * anything.
 * &lt;/p>
 *
 * &lt;p>
 * Folks that would like to experiment with alternative storage backends
 * should look at the {@link HttpCacheStorage} interface and the related
 * package documentation there. You may also be interested in the provided
 * {@link org.apache.http.impl.client.cache.ehcache.EhcacheHttpCacheStorage
 * EhCache} and {@link
 * org.apache.http.impl.client.cache.memcached.MemcachedHttpCacheStorage
 * memcached} storage backends.
 * &lt;/p>
 * @since 4.1
 *
 * @deprecated (4.3) use {@link CachingHttpClientBuilder} or {@link CachingHttpClients}.
 */</div><span>/*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>128</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>@Deprecated</pre></td>
    </tr>
    <tr>
      <td class='line'>129</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>@ThreadSafe // So long as the responseCache implementation is threadsafe</pre></td>
    </tr>
    <tr>
      <td class='line'>130</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>public class CachingHttpClient implements HttpClient {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * This is the name under which the {@link
     * org.apache.http.client.cache.CacheResponseStatus} of a request
     * (for example, whether it resulted in a cache hit) will be recorded if an
     * {@link HttpContext} is provided during execution.
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>138</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public static final String CACHE_RESPONSE_STATUS = "http.cache.response.status";</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>140</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final static boolean SUPPORTS_RANGE_AND_CONTENT_RANGE_HEADERS = false;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>142</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final AtomicLong cacheHits = new AtomicLong();</pre></td>
    </tr>
    <tr>
      <td class='line'>143</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final AtomicLong cacheMisses = new AtomicLong();</pre></td>
    </tr>
    <tr>
      <td class='line'>144</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final AtomicLong cacheUpdates = new AtomicLong();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>146</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final Map&lt;ProtocolVersion, String> viaHeaders = new HashMap&lt;ProtocolVersion, String>(4);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>148</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final HttpClient backend;</pre></td>
    </tr>
    <tr>
      <td class='line'>149</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final HttpCache responseCache;</pre></td>
    </tr>
    <tr>
      <td class='line'>150</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final CacheValidityPolicy validityPolicy;</pre></td>
    </tr>
    <tr>
      <td class='line'>151</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final ResponseCachingPolicy responseCachingPolicy;</pre></td>
    </tr>
    <tr>
      <td class='line'>152</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final CachedHttpResponseGenerator responseGenerator;</pre></td>
    </tr>
    <tr>
      <td class='line'>153</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final CacheableRequestPolicy cacheableRequestPolicy;</pre></td>
    </tr>
    <tr>
      <td class='line'>154</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final CachedResponseSuitabilityChecker suitabilityChecker;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>156</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final ConditionalRequestBuilder conditionalRequestBuilder;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>158</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final long maxObjectSizeBytes;</pre></td>
    </tr>
    <tr>
      <td class='line'>159</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final boolean sharedCache;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>161</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final ResponseProtocolCompliance responseCompliance;</pre></td>
    </tr>
    <tr>
      <td class='line'>162</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final RequestProtocolCompliance requestCompliance;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>164</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final AsynchronousValidator asynchRevalidator;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>166</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final Log log = LogFactory.getLog(getClass());</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>168</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    CachingHttpClient(</pre></td>
    </tr>
    <tr>
      <td class='line'>169</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpClient client,</pre></td>
    </tr>
    <tr>
      <td class='line'>170</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCache cache,</pre></td>
    </tr>
    <tr>
      <td class='line'>171</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>172</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        super();</pre></td>
    </tr>
    <tr>
      <td class='line'>173</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Args.notNull(client, "HttpClient");</pre></td>
    </tr>
    <tr>
      <td class='line'>174</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Args.notNull(cache, "HttpCache");</pre></td>
    </tr>
    <tr>
      <td class='line'>175</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Args.notNull(config, "CacheConfig");</pre></td>
    </tr>
    <tr>
      <td class='line'>176</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.maxObjectSizeBytes = config.getMaxObjectSize();</pre></td>
    </tr>
    <tr>
      <td class='line'>177</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.sharedCache = config.isSharedCache();</pre></td>
    </tr>
    <tr>
      <td class='line'>178</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.backend = client;</pre></td>
    </tr>
    <tr>
      <td class='line'>179</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseCache = cache;</pre></td>
    </tr>
    <tr>
      <td class='line'>180</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.validityPolicy = new CacheValidityPolicy();</pre></td>
    </tr>
    <tr>
      <td class='line'>181</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseCachingPolicy = new ResponseCachingPolicy(maxObjectSizeBytes, sharedCache,</pre></td>
    </tr>
    <tr>
      <td class='line'>182</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                config.isNeverCacheHTTP10ResponsesWithQuery(), config.is303CachingEnabled());</pre></td>
    </tr>
    <tr>
      <td class='line'>183</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseGenerator = new CachedHttpResponseGenerator(this.validityPolicy);</pre></td>
    </tr>
    <tr>
      <td class='line'>184</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.cacheableRequestPolicy = new CacheableRequestPolicy();</pre></td>
    </tr>
    <tr>
      <td class='line'>185</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.suitabilityChecker = new CachedResponseSuitabilityChecker(this.validityPolicy, config);</pre></td>
    </tr>
    <tr>
      <td class='line'>186</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.conditionalRequestBuilder = new ConditionalRequestBuilder();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>188</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseCompliance = new ResponseProtocolCompliance();</pre></td>
    </tr>
    <tr>
      <td class='line'>189</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.requestCompliance = new RequestProtocolCompliance(config.isWeakETagOnPutDeleteAllowed());</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>191</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.asynchRevalidator = makeAsynchronousValidator(config);</pre></td>
    </tr>
    <tr>
      <td class='line'>192</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Constructs a {@code CachingHttpClient} with default caching settings that
     * stores cache entries in memory and uses a vanilla {@link DefaultHttpClient}
     * for backend requests.
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>199</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public CachingHttpClient() {</pre></td>
    </tr>
    <tr>
      <td class='line'>200</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this(new DefaultHttpClient(),</pre></td>
    </tr>
    <tr>
      <td class='line'>201</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new BasicHttpCache(),</pre></td>
    </tr>
    <tr>
      <td class='line'>202</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new CacheConfig());</pre></td>
    </tr>
    <tr>
      <td class='line'>203</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Constructs a {@code CachingHttpClient} with the given caching options that
     * stores cache entries in memory and uses a vanilla {@link DefaultHttpClient}
     * for backend requests.
     * @param config cache module options
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>211</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public CachingHttpClient(final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>212</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this(new DefaultHttpClient(),</pre></td>
    </tr>
    <tr>
      <td class='line'>213</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new BasicHttpCache(config),</pre></td>
    </tr>
    <tr>
      <td class='line'>214</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                config);</pre></td>
    </tr>
    <tr>
      <td class='line'>215</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Constructs a {@code CachingHttpClient} with default caching settings that
     * stores cache entries in memory and uses the given {@link HttpClient}
     * for backend requests.
     * @param client used to make origin requests
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>223</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public CachingHttpClient(final HttpClient client) {</pre></td>
    </tr>
    <tr>
      <td class='line'>224</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this(client,</pre></td>
    </tr>
    <tr>
      <td class='line'>225</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new BasicHttpCache(),</pre></td>
    </tr>
    <tr>
      <td class='line'>226</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new CacheConfig());</pre></td>
    </tr>
    <tr>
      <td class='line'>227</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Constructs a {@code CachingHttpClient} with the given caching options that
     * stores cache entries in memory and uses the given {@link HttpClient}
     * for backend requests.
     * @param config cache module options
     * @param client used to make origin requests
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>236</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public CachingHttpClient(final HttpClient client, final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>237</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this(client,</pre></td>
    </tr>
    <tr>
      <td class='line'>238</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new BasicHttpCache(config),</pre></td>
    </tr>
    <tr>
      <td class='line'>239</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                config);</pre></td>
    </tr>
    <tr>
      <td class='line'>240</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Constructs a {@code CachingHttpClient} with the given caching options
     * that stores cache entries in the provided storage backend and uses
     * the given {@link HttpClient} for backend requests. However, cached
     * response bodies are managed using the given {@link ResourceFactory}.
     * @param client used to make origin requests
     * @param resourceFactory how to manage cached response bodies
     * @param storage where to store cache entries
     * @param config cache module options
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>252</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public CachingHttpClient(</pre></td>
    </tr>
    <tr>
      <td class='line'>253</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpClient client,</pre></td>
    </tr>
    <tr>
      <td class='line'>254</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final ResourceFactory resourceFactory,</pre></td>
    </tr>
    <tr>
      <td class='line'>255</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheStorage storage,</pre></td>
    </tr>
    <tr>
      <td class='line'>256</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>257</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this(client,</pre></td>
    </tr>
    <tr>
      <td class='line'>258</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new BasicHttpCache(resourceFactory, storage, config),</pre></td>
    </tr>
    <tr>
      <td class='line'>259</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                config);</pre></td>
    </tr>
    <tr>
      <td class='line'>260</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Constructs a {@code CachingHttpClient} with the given caching options
     * that stores cache entries in the provided storage backend and uses
     * the given {@link HttpClient} for backend requests.
     * @param client used to make origin requests
     * @param storage where to store cache entries
     * @param config cache module options
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>270</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public CachingHttpClient(</pre></td>
    </tr>
    <tr>
      <td class='line'>271</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpClient client,</pre></td>
    </tr>
    <tr>
      <td class='line'>272</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheStorage storage,</pre></td>
    </tr>
    <tr>
      <td class='line'>273</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>274</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this(client,</pre></td>
    </tr>
    <tr>
      <td class='line'>275</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                new BasicHttpCache(new HeapResourceFactory(), storage, config),</pre></td>
    </tr>
    <tr>
      <td class='line'>276</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                config);</pre></td>
    </tr>
    <tr>
      <td class='line'>277</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>279</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    CachingHttpClient(</pre></td>
    </tr>
    <tr>
      <td class='line'>280</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpClient backend,</pre></td>
    </tr>
    <tr>
      <td class='line'>281</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CacheValidityPolicy validityPolicy,</pre></td>
    </tr>
    <tr>
      <td class='line'>282</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final ResponseCachingPolicy responseCachingPolicy,</pre></td>
    </tr>
    <tr>
      <td class='line'>283</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCache responseCache,</pre></td>
    </tr>
    <tr>
      <td class='line'>284</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CachedHttpResponseGenerator responseGenerator,</pre></td>
    </tr>
    <tr>
      <td class='line'>285</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CacheableRequestPolicy cacheableRequestPolicy,</pre></td>
    </tr>
    <tr>
      <td class='line'>286</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CachedResponseSuitabilityChecker suitabilityChecker,</pre></td>
    </tr>
    <tr>
      <td class='line'>287</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final ConditionalRequestBuilder conditionalRequestBuilder,</pre></td>
    </tr>
    <tr>
      <td class='line'>288</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final ResponseProtocolCompliance responseCompliance,</pre></td>
    </tr>
    <tr>
      <td class='line'>289</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final RequestProtocolCompliance requestCompliance) {</pre></td>
    </tr>
    <tr>
      <td class='line'>290</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final CacheConfig config = new CacheConfig();</pre></td>
    </tr>
    <tr>
      <td class='line'>291</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.maxObjectSizeBytes = config.getMaxObjectSize();</pre></td>
    </tr>
    <tr>
      <td class='line'>292</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.sharedCache = config.isSharedCache();</pre></td>
    </tr>
    <tr>
      <td class='line'>293</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.backend = backend;</pre></td>
    </tr>
    <tr>
      <td class='line'>294</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.validityPolicy = validityPolicy;</pre></td>
    </tr>
    <tr>
      <td class='line'>295</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseCachingPolicy = responseCachingPolicy;</pre></td>
    </tr>
    <tr>
      <td class='line'>296</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseCache = responseCache;</pre></td>
    </tr>
    <tr>
      <td class='line'>297</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseGenerator = responseGenerator;</pre></td>
    </tr>
    <tr>
      <td class='line'>298</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.cacheableRequestPolicy = cacheableRequestPolicy;</pre></td>
    </tr>
    <tr>
      <td class='line'>299</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.suitabilityChecker = suitabilityChecker;</pre></td>
    </tr>
    <tr>
      <td class='line'>300</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.conditionalRequestBuilder = conditionalRequestBuilder;</pre></td>
    </tr>
    <tr>
      <td class='line'>301</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.responseCompliance = responseCompliance;</pre></td>
    </tr>
    <tr>
      <td class='line'>302</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.requestCompliance = requestCompliance;</pre></td>
    </tr>
    <tr>
      <td class='line'>303</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.asynchRevalidator = makeAsynchronousValidator(config);</pre></td>
    </tr>
    <tr>
      <td class='line'>304</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>306</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private AsynchronousValidator makeAsynchronousValidator(</pre></td>
    </tr>
    <tr>
      <td class='line'>307</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>308</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (config.getAsynchronousWorkersMax() > 0) {</pre></td>
    </tr>
    <tr>
      <td class='line'>309</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return new AsynchronousValidator(this, config);</pre></td>
    </tr>
    <tr>
      <td class='line'>310</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>311</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return null;</pre></td>
    </tr>
    <tr>
      <td class='line'>312</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Reports the number of times that the cache successfully responded
     * to an {@link HttpRequest} without contacting the origin server.
     * @return the number of cache hits
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>319</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public long getCacheHits() {</pre></td>
    </tr>
    <tr>
      <td class='line'>320</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return cacheHits.get();</pre></td>
    </tr>
    <tr>
      <td class='line'>321</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Reports the number of times that the cache contacted the origin
     * server because it had no appropriate response cached.
     * @return the number of cache misses
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>328</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public long getCacheMisses() {</pre></td>
    </tr>
    <tr>
      <td class='line'>329</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return cacheMisses.get();</pre></td>
    </tr>
    <tr>
      <td class='line'>330</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Reports the number of times that the cache was able to satisfy
     * a response by revalidating an existing but stale cache entry.
     * @return the number of cache revalidations
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>337</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public long getCacheUpdates() {</pre></td>
    </tr>
    <tr>
      <td class='line'>338</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return cacheUpdates.get();</pre></td>
    </tr>
    <tr>
      <td class='line'>339</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>341</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public HttpResponse execute(final HttpHost target, final HttpRequest request) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>342</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpContext defaultContext = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>343</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return execute(target, request, defaultContext);</pre></td>
    </tr>
    <tr>
      <td class='line'>344</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>346</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public &lt;T> T execute(final HttpHost target, final HttpRequest request,</pre></td>
    </tr>
    <tr>
      <td class='line'>347</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                         final ResponseHandler&lt;? extends T> responseHandler) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>348</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return execute(target, request, responseHandler, null);</pre></td>
    </tr>
    <tr>
      <td class='line'>349</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>351</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public &lt;T> T execute(final HttpHost target, final HttpRequest request,</pre></td>
    </tr>
    <tr>
      <td class='line'>352</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                         final ResponseHandler&lt;? extends T> responseHandler, final HttpContext context) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>353</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse resp = execute(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>354</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return handleAndConsume(responseHandler,resp);</pre></td>
    </tr>
    <tr>
      <td class='line'>355</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>357</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public HttpResponse execute(final HttpUriRequest request) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>358</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpContext context = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>359</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return execute(request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>360</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>362</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public HttpResponse execute(final HttpUriRequest request, final HttpContext context) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>363</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final URI uri = request.getURI();</pre></td>
    </tr>
    <tr>
      <td class='line'>364</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpHost httpHost = new HttpHost(uri.getHost(), uri.getPort(), uri.getScheme());</pre></td>
    </tr>
    <tr>
      <td class='line'>365</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return execute(httpHost, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>366</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>368</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public &lt;T> T execute(final HttpUriRequest request, final ResponseHandler&lt;? extends T> responseHandler)</pre></td>
    </tr>
    <tr>
      <td class='line'>369</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>370</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return execute(request, responseHandler, null);</pre></td>
    </tr>
    <tr>
      <td class='line'>371</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>373</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public &lt;T> T execute(final HttpUriRequest request, final ResponseHandler&lt;? extends T> responseHandler,</pre></td>
    </tr>
    <tr>
      <td class='line'>374</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                         final HttpContext context) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>375</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse resp = execute(request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>376</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return handleAndConsume(responseHandler, resp);</pre></td>
    </tr>
    <tr>
      <td class='line'>377</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>379</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private &lt;T> T handleAndConsume(</pre></td>
    </tr>
    <tr>
      <td class='line'>380</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final ResponseHandler&lt;? extends T> responseHandler,</pre></td>
    </tr>
    <tr>
      <td class='line'>381</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpResponse response) throws Error, IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>382</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        T result;</pre></td>
    </tr>
    <tr>
      <td class='line'>383</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>384</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            result = responseHandler.handleResponse(response);</pre></td>
    </tr>
    <tr>
      <td class='line'>385</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final Exception t) {</pre></td>
    </tr>
    <tr>
      <td class='line'>386</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpEntity entity = response.getEntity();</pre></td>
    </tr>
    <tr>
      <td class='line'>387</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>388</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                IOUtils.consume(entity);</pre></td>
    </tr>
    <tr>
      <td class='line'>389</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (final Exception t2) {</pre></td>
    </tr>
    <tr>
      <td class='line'>390</td><td>&nbsp;</td>
      <td><pre class='comment'>                // Log this exception. The original exception is more</pre></td>
    </tr>
    <tr>
      <td class='line'>391</td><td>&nbsp;</td>
      <td><pre class='comment'>                // important and will be thrown to the caller.</pre></td>
    </tr>
    <tr>
      <td class='line'>392</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                this.log.warn("Error consuming content after an exception.", t2);</pre></td>
    </tr>
    <tr>
      <td class='line'>393</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>394</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (t instanceof RuntimeException) {</pre></td>
    </tr>
    <tr>
      <td class='line'>395</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                throw (RuntimeException) t;</pre></td>
    </tr>
    <tr>
      <td class='line'>396</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>397</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (t instanceof IOException) {</pre></td>
    </tr>
    <tr>
      <td class='line'>398</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                throw (IOException) t;</pre></td>
    </tr>
    <tr>
      <td class='line'>399</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>400</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw new UndeclaredThrowableException(t);</pre></td>
    </tr>
    <tr>
      <td class='line'>401</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>403</td><td>&nbsp;</td>
      <td><pre class='comment'>        // Handling the response was successful. Ensure that the content has</pre></td>
    </tr>
    <tr>
      <td class='line'>404</td><td>&nbsp;</td>
      <td><pre class='comment'>        // been fully consumed.</pre></td>
    </tr>
    <tr>
      <td class='line'>405</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpEntity entity = response.getEntity();</pre></td>
    </tr>
    <tr>
      <td class='line'>406</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        IOUtils.consume(entity);</pre></td>
    </tr>
    <tr>
      <td class='line'>407</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return result;</pre></td>
    </tr>
    <tr>
      <td class='line'>408</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>410</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public ClientConnectionManager getConnectionManager() {</pre></td>
    </tr>
    <tr>
      <td class='line'>411</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return backend.getConnectionManager();</pre></td>
    </tr>
    <tr>
      <td class='line'>412</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>414</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public HttpParams getParams() {</pre></td>
    </tr>
    <tr>
      <td class='line'>415</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return backend.getParams();</pre></td>
    </tr>
    <tr>
      <td class='line'>416</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>418</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public HttpResponse execute(final HttpHost target, final HttpRequest originalRequest, final HttpContext context)</pre></td>
    </tr>
    <tr>
      <td class='line'>419</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>421</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpRequestWrapper request;</pre></td>
    </tr>
    <tr>
      <td class='line'>422</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (originalRequest instanceof HttpRequestWrapper) {</pre></td>
    </tr>
    <tr>
      <td class='line'>423</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            request = ((HttpRequestWrapper) originalRequest);</pre></td>
    </tr>
    <tr>
      <td class='line'>424</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>425</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            request = HttpRequestWrapper.wrap(originalRequest);</pre></td>
    </tr>
    <tr>
      <td class='line'>426</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>427</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final String via = generateViaHeader(originalRequest);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>429</td><td>&nbsp;</td>
      <td><pre class='comment'>        // default response context</pre></td>
    </tr>
    <tr>
      <td class='line'>430</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        setResponseStatus(context, CacheResponseStatus.CACHE_MISS);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>432</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (clientRequestsOurOptions(request)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>433</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            setResponseStatus(context, CacheResponseStatus.CACHE_MODULE_RESPONSE);</pre></td>
    </tr>
    <tr>
      <td class='line'>434</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return new OptionsHttp11Response();</pre></td>
    </tr>
    <tr>
      <td class='line'>435</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>437</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse fatalErrorResponse = getFatallyNoncompliantResponse(</pre></td>
    </tr>
    <tr>
      <td class='line'>438</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>439</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (fatalErrorResponse != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>440</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return fatalErrorResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>441</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>443</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        requestCompliance.makeRequestCompliant(request);</pre></td>
    </tr>
    <tr>
      <td class='line'>444</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        request.addHeader("Via",via);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>446</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        flushEntriesInvalidatedByRequest(target, request);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>448</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!cacheableRequestPolicy.isServableFromCache(request)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>449</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.debug("Request is not servable from cache");</pre></td>
    </tr>
    <tr>
      <td class='line'>450</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return callBackend(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>451</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>453</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpCacheEntry entry = satisfyFromCache(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>454</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (entry == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>455</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.debug("Cache miss");</pre></td>
    </tr>
    <tr>
      <td class='line'>456</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return handleCacheMiss(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>457</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>459</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return handleCacheHit(target, request, context, entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>460</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>462</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse handleCacheHit(final HttpHost target, final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>463</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context, final HttpCacheEntry entry)</pre></td>
    </tr>
    <tr>
      <td class='line'>464</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throws ClientProtocolException, IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>465</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        recordCacheHit(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>466</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpResponse out = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>467</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Date now = getCurrentDate();</pre></td>
    </tr>
    <tr>
      <td class='line'>468</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (suitabilityChecker.canCachedResponseBeUsed(target, request, entry, now)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>469</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.debug("Cache hit");</pre></td>
    </tr>
    <tr>
      <td class='line'>470</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            out = generateCachedResponse(request, context, entry, now);</pre></td>
    </tr>
    <tr>
      <td class='line'>471</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } else if (!mayCallBackend(request)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>472</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.debug("Cache entry not suitable but only-if-cached requested");</pre></td>
    </tr>
    <tr>
      <td class='line'>473</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            out = generateGatewayTimeout(context);</pre></td>
    </tr>
    <tr>
      <td class='line'>474</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>475</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.debug("Revalidating cache entry");</pre></td>
    </tr>
    <tr>
      <td class='line'>476</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return revalidateCacheEntry(target, request, context, entry, now);</pre></td>
    </tr>
    <tr>
      <td class='line'>477</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>478</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (context != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>479</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            context.setAttribute(ExecutionContext.HTTP_TARGET_HOST, target);</pre></td>
    </tr>
    <tr>
      <td class='line'>480</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            context.setAttribute(ExecutionContext.HTTP_REQUEST, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>481</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            context.setAttribute(ExecutionContext.HTTP_RESPONSE, out);</pre></td>
    </tr>
    <tr>
      <td class='line'>482</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            context.setAttribute(ExecutionContext.HTTP_REQ_SENT, Boolean.TRUE);</pre></td>
    </tr>
    <tr>
      <td class='line'>483</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>484</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return out;</pre></td>
    </tr>
    <tr>
      <td class='line'>485</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>487</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse revalidateCacheEntry(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>488</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request, final HttpContext context, final HttpCacheEntry entry,</pre></td>
    </tr>
    <tr>
      <td class='line'>489</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Date now) throws ClientProtocolException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>491</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>492</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (asynchRevalidator != null</pre></td>
    </tr>
    <tr>
      <td class='line'>493</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                && !staleResponseNotAllowed(request, entry, now)</pre></td>
    </tr>
    <tr>
      <td class='line'>494</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                && validityPolicy.mayReturnStaleWhileRevalidating(entry, now)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>495</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                log.trace("Serving stale with asynchronous revalidation");</pre></td>
    </tr>
    <tr>
      <td class='line'>496</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final HttpResponse resp = generateCachedResponse(request, context, entry, now);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>498</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                asynchRevalidator.revalidateCacheEntry(target, request, context, entry);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>500</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                return resp;</pre></td>
    </tr>
    <tr>
      <td class='line'>501</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>502</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return revalidateCacheEntry(target, request, context, entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>503</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioex) {</pre></td>
    </tr>
    <tr>
      <td class='line'>504</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return handleRevalidationFailure(request, context, entry, now);</pre></td>
    </tr>
    <tr>
      <td class='line'>505</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final ProtocolException e) {</pre></td>
    </tr>
    <tr>
      <td class='line'>506</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw new ClientProtocolException(e);</pre></td>
    </tr>
    <tr>
      <td class='line'>507</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>508</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>510</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse handleCacheMiss(final HttpHost target, final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>511</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>512</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        recordCacheMiss(target, request);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>514</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!mayCallBackend(request)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>515</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return new BasicHttpResponse(HttpVersion.HTTP_1_1, HttpStatus.SC_GATEWAY_TIMEOUT,</pre></td>
    </tr>
    <tr>
      <td class='line'>516</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    "Gateway Timeout");</pre></td>
    </tr>
    <tr>
      <td class='line'>517</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>519</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Map&lt;String, Variant> variants =</pre></td>
    </tr>
    <tr>
      <td class='line'>520</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            getExistingCacheVariants(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>521</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (variants != null && variants.size() > 0) {</pre></td>
    </tr>
    <tr>
      <td class='line'>522</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return negotiateResponseFromVariants(target, request, context, variants);</pre></td>
    </tr>
    <tr>
      <td class='line'>523</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>525</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return callBackend(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>526</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>528</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpCacheEntry satisfyFromCache(final HttpHost target, final HttpRequestWrapper request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>529</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpCacheEntry entry = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>530</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>531</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            entry = responseCache.getCacheEntry(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>532</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>533</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.warn("Unable to retrieve entries from cache", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>534</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>535</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return entry;</pre></td>
    </tr>
    <tr>
      <td class='line'>536</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>538</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse getFatallyNoncompliantResponse(final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>539</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context) {</pre></td>
    </tr>
    <tr>
      <td class='line'>540</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpResponse fatalErrorResponse = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>541</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final List&lt;RequestProtocolError> fatalError = requestCompliance.requestIsFatallyNonCompliant(request);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>543</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        for (final RequestProtocolError error : fatalError) {</pre></td>
    </tr>
    <tr>
      <td class='line'>544</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            setResponseStatus(context, CacheResponseStatus.CACHE_MODULE_RESPONSE);</pre></td>
    </tr>
    <tr>
      <td class='line'>545</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            fatalErrorResponse = requestCompliance.getErrorForRequest(error);</pre></td>
    </tr>
    <tr>
      <td class='line'>546</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>547</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return fatalErrorResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>548</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>550</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private Map&lt;String, Variant> getExistingCacheVariants(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>551</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>552</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Map&lt;String,Variant> variants = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>553</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>554</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            variants = responseCache.getVariantCacheEntriesWithEtags(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>555</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>556</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.warn("Unable to retrieve variant entries from cache", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>557</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>558</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return variants;</pre></td>
    </tr>
    <tr>
      <td class='line'>559</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>561</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void recordCacheMiss(final HttpHost target, final HttpRequestWrapper request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>562</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        cacheMisses.getAndIncrement();</pre></td>
    </tr>
    <tr>
      <td class='line'>563</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (log.isTraceEnabled()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>564</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final RequestLine rl = request.getRequestLine();</pre></td>
    </tr>
    <tr>
      <td class='line'>565</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.trace("Cache miss [host: " + target + "; uri: " + rl.getUri() + "]");</pre></td>
    </tr>
    <tr>
      <td class='line'>566</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>567</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>569</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void recordCacheHit(final HttpHost target, final HttpRequestWrapper request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>570</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        cacheHits.getAndIncrement();</pre></td>
    </tr>
    <tr>
      <td class='line'>571</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (log.isTraceEnabled()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>572</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final RequestLine rl = request.getRequestLine();</pre></td>
    </tr>
    <tr>
      <td class='line'>573</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.trace("Cache hit [host: " + target + "; uri: " + rl.getUri() + "]");</pre></td>
    </tr>
    <tr>
      <td class='line'>574</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>575</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>577</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void recordCacheUpdate(final HttpContext context) {</pre></td>
    </tr>
    <tr>
      <td class='line'>578</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        cacheUpdates.getAndIncrement();</pre></td>
    </tr>
    <tr>
      <td class='line'>579</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        setResponseStatus(context, CacheResponseStatus.VALIDATED);</pre></td>
    </tr>
    <tr>
      <td class='line'>580</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>582</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void flushEntriesInvalidatedByRequest(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>583</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>584</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>585</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            responseCache.flushInvalidatedCacheEntriesFor(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>586</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>587</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.warn("Unable to flush invalidated entries from cache", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>588</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>589</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>591</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse generateCachedResponse(final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>592</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context, final HttpCacheEntry entry, final Date now) {</pre></td>
    </tr>
    <tr>
      <td class='line'>593</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse cachedResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>594</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (request.containsHeader(HeaderConstants.IF_NONE_MATCH)</pre></td>
    </tr>
    <tr>
      <td class='line'>595</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                || request.containsHeader(HeaderConstants.IF_MODIFIED_SINCE)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>596</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            cachedResponse = responseGenerator.generateNotModifiedResponse(entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>597</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>598</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            cachedResponse = responseGenerator.generateResponse(request, entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>599</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>600</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        setResponseStatus(context, CacheResponseStatus.CACHE_HIT);</pre></td>
    </tr>
    <tr>
      <td class='line'>601</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (validityPolicy.getStalenessSecs(entry, now) > 0L) {</pre></td>
    </tr>
    <tr>
      <td class='line'>602</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            cachedResponse.addHeader(HeaderConstants.WARNING,"110 localhost \"Response is stale\"");</pre></td>
    </tr>
    <tr>
      <td class='line'>603</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>604</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return cachedResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>605</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>607</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse handleRevalidationFailure(final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>608</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context, final HttpCacheEntry entry, final Date now) {</pre></td>
    </tr>
    <tr>
      <td class='line'>609</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (staleResponseNotAllowed(request, entry, now)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>610</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return generateGatewayTimeout(context);</pre></td>
    </tr>
    <tr>
      <td class='line'>611</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>612</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return unvalidatedCacheHit(request, context, entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>613</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>614</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>616</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse generateGatewayTimeout(final HttpContext context) {</pre></td>
    </tr>
    <tr>
      <td class='line'>617</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        setResponseStatus(context, CacheResponseStatus.CACHE_MODULE_RESPONSE);</pre></td>
    </tr>
    <tr>
      <td class='line'>618</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return new BasicHttpResponse(HttpVersion.HTTP_1_1,</pre></td>
    </tr>
    <tr>
      <td class='line'>619</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                HttpStatus.SC_GATEWAY_TIMEOUT, "Gateway Timeout");</pre></td>
    </tr>
    <tr>
      <td class='line'>620</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>622</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse unvalidatedCacheHit(</pre></td>
    </tr>
    <tr>
      <td class='line'>623</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>624</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context,</pre></td>
    </tr>
    <tr>
      <td class='line'>625</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry entry) {</pre></td>
    </tr>
    <tr>
      <td class='line'>626</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse cachedResponse = responseGenerator.generateResponse(request, entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>627</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        setResponseStatus(context, CacheResponseStatus.CACHE_HIT);</pre></td>
    </tr>
    <tr>
      <td class='line'>628</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        cachedResponse.addHeader(HeaderConstants.WARNING, "111 localhost \"Revalidation failed\"");</pre></td>
    </tr>
    <tr>
      <td class='line'>629</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return cachedResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>630</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>632</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean staleResponseNotAllowed(final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>633</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry entry, final Date now) {</pre></td>
    </tr>
    <tr>
      <td class='line'>634</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return validityPolicy.mustRevalidate(entry)</pre></td>
    </tr>
    <tr>
      <td class='line'>635</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            || (isSharedCache() && validityPolicy.proxyRevalidate(entry))</pre></td>
    </tr>
    <tr>
      <td class='line'>636</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            || explicitFreshnessRequest(request, entry, now);</pre></td>
    </tr>
    <tr>
      <td class='line'>637</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>639</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean mayCallBackend(final HttpRequestWrapper request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>640</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        for (final Header h: request.getHeaders(HeaderConstants.CACHE_CONTROL)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>641</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            for (final HeaderElement elt : h.getElements()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>642</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                if ("only-if-cached".equals(elt.getName())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>643</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    log.trace("Request marked only-if-cached");</pre></td>
    </tr>
    <tr>
      <td class='line'>644</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>645</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                }</pre></td>
    </tr>
    <tr>
      <td class='line'>646</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>647</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>648</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return true;</pre></td>
    </tr>
    <tr>
      <td class='line'>649</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>651</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean explicitFreshnessRequest(final HttpRequestWrapper request, final HttpCacheEntry entry, final Date now) {</pre></td>
    </tr>
    <tr>
      <td class='line'>652</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        for(final Header h : request.getHeaders(HeaderConstants.CACHE_CONTROL)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>653</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            for(final HeaderElement elt : h.getElements()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>654</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                if (HeaderConstants.CACHE_CONTROL_MAX_STALE.equals(elt.getName())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>655</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    try {</pre></td>
    </tr>
    <tr>
      <td class='line'>656</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        final int maxstale = Integer.parseInt(elt.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>657</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        final long age = validityPolicy.getCurrentAgeSecs(entry, now);</pre></td>
    </tr>
    <tr>
      <td class='line'>658</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        final long lifetime = validityPolicy.getFreshnessLifetimeSecs(entry);</pre></td>
    </tr>
    <tr>
      <td class='line'>659</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        if (age - lifetime > maxstale) {</pre></td>
    </tr>
    <tr>
      <td class='line'>660</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            return true;</pre></td>
    </tr>
    <tr>
      <td class='line'>661</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        }</pre></td>
    </tr>
    <tr>
      <td class='line'>662</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    } catch (final NumberFormatException nfe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>663</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        return true;</pre></td>
    </tr>
    <tr>
      <td class='line'>664</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    }</pre></td>
    </tr>
    <tr>
      <td class='line'>665</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                } else if (HeaderConstants.CACHE_CONTROL_MIN_FRESH.equals(elt.getName())</pre></td>
    </tr>
    <tr>
      <td class='line'>666</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            || HeaderConstants.CACHE_CONTROL_MAX_AGE.equals(elt.getName())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>667</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    return true;</pre></td>
    </tr>
    <tr>
      <td class='line'>668</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                }</pre></td>
    </tr>
    <tr>
      <td class='line'>669</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>670</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>671</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>672</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>674</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private String generateViaHeader(final HttpMessage msg) {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>676</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final ProtocolVersion pv = msg.getProtocolVersion();</pre></td>
    </tr>
    <tr>
      <td class='line'>677</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final String existingEntry = viaHeaders.get(pv);</pre></td>
    </tr>
    <tr>
      <td class='line'>678</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (existingEntry != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>679</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return existingEntry;</pre></td>
    </tr>
    <tr>
      <td class='line'>680</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>682</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final VersionInfo vi = VersionInfo.loadVersionInfo("org.apache.http.client", getClass().getClassLoader());</pre></td>
    </tr>
    <tr>
      <td class='line'>683</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final String release = (vi != null) ? vi.getRelease() : VersionInfo.UNAVAILABLE;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>685</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        String value;</pre></td>
    </tr>
    <tr>
      <td class='line'>686</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if ("http".equalsIgnoreCase(pv.getProtocol())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>687</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            value = String.format("%d.%d localhost (Apache-HttpClient/%s (cache))", pv.getMajor(), pv.getMinor(),</pre></td>
    </tr>
    <tr>
      <td class='line'>688</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    release);</pre></td>
    </tr>
    <tr>
      <td class='line'>689</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>690</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            value = String.format("%s/%d.%d localhost (Apache-HttpClient/%s (cache))", pv.getProtocol(), pv.getMajor(),</pre></td>
    </tr>
    <tr>
      <td class='line'>691</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    pv.getMinor(), release);</pre></td>
    </tr>
    <tr>
      <td class='line'>692</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>693</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        viaHeaders.put(pv, value);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>695</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return value;</pre></td>
    </tr>
    <tr>
      <td class='line'>696</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>698</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void setResponseStatus(final HttpContext context, final CacheResponseStatus value) {</pre></td>
    </tr>
    <tr>
      <td class='line'>699</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (context != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>700</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            context.setAttribute(CACHE_RESPONSE_STATUS, value);</pre></td>
    </tr>
    <tr>
      <td class='line'>701</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>702</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Reports whether this {@code CachingHttpClient} implementation
     * supports byte-range requests as specified by the {@code Range}
     * and {@code Content-Range} headers.
     * @return {@code true} if byte-range requests are supported
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>710</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public boolean supportsRangeAndContentRangeHeaders() {</pre></td>
    </tr>
    <tr>
      <td class='line'>711</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return SUPPORTS_RANGE_AND_CONTENT_RANGE_HEADERS;</pre></td>
    </tr>
    <tr>
      <td class='line'>712</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * Reports whether this {@code CachingHttpClient} is configured as
     * a shared (public) or non-shared (private) cache. See {@link
     * CacheConfig#setSharedCache(boolean)}.
     * @return {@code true} if we are behaving as a shared (public)
     *   cache
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>721</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public boolean isSharedCache() {</pre></td>
    </tr>
    <tr>
      <td class='line'>722</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return sharedCache;</pre></td>
    </tr>
    <tr>
      <td class='line'>723</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>725</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    Date getCurrentDate() {</pre></td>
    </tr>
    <tr>
      <td class='line'>726</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return new Date();</pre></td>
    </tr>
    <tr>
      <td class='line'>727</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>729</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    boolean clientRequestsOurOptions(final HttpRequest request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>730</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final RequestLine line = request.getRequestLine();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>732</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!HeaderConstants.OPTIONS_METHOD.equals(line.getMethod())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>733</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>734</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>736</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!"*".equals(line.getUri())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>737</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>738</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>740</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!"0".equals(request.getFirstHeader(HeaderConstants.MAX_FORWARDS).getValue())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>741</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>742</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>744</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return true;</pre></td>
    </tr>
    <tr>
      <td class='line'>745</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>747</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    HttpResponse callBackend(final HttpHost target, final HttpRequestWrapper request, final HttpContext context)</pre></td>
    </tr>
    <tr>
      <td class='line'>748</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>750</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Date requestDate = getCurrentDate();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>752</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        log.trace("Calling the backend");</pre></td>
    </tr>
    <tr>
      <td class='line'>753</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse backendResponse = backend.execute(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>754</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        backendResponse.addHeader("Via", generateViaHeader(backendResponse));</pre></td>
    </tr>
    <tr>
      <td class='line'>755</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return handleBackendResponse(target, request, requestDate, getCurrentDate(),</pre></td>
    </tr>
    <tr>
      <td class='line'>756</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                backendResponse);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>758</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>760</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean revalidationResponseIsTooOld(final HttpResponse backendResponse,</pre></td>
    </tr>
    <tr>
      <td class='line'>761</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry cacheEntry) {</pre></td>
    </tr>
    <tr>
      <td class='line'>762</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Header entryDateHeader = cacheEntry.getFirstHeader(HTTP.DATE_HEADER);</pre></td>
    </tr>
    <tr>
      <td class='line'>763</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Header responseDateHeader = backendResponse.getFirstHeader(HTTP.DATE_HEADER);</pre></td>
    </tr>
    <tr>
      <td class='line'>764</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (entryDateHeader != null && responseDateHeader != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>765</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>766</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final Date entryDate = DateUtils.parseDate(entryDateHeader.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>767</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final Date respDate = DateUtils.parseDate(responseDateHeader.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>768</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                if (respDate.before(entryDate)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>769</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    return true;</pre></td>
    </tr>
    <tr>
      <td class='line'>770</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                }</pre></td>
    </tr>
    <tr>
      <td class='line'>771</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (final DateParseException e) {</pre></td>
    </tr>
    <tr>
      <td class='line'>772</td><td>&nbsp;</td>
      <td><pre class='comment'>                // either backend response or cached entry did not have a valid</pre></td>
    </tr>
    <tr>
      <td class='line'>773</td><td>&nbsp;</td>
      <td><pre class='comment'>                // Date header, so we can't tell if they are out of order</pre></td>
    </tr>
    <tr>
      <td class='line'>774</td><td>&nbsp;</td>
      <td><pre class='comment'>                // according to the origin clock; thus we can skip the</pre></td>
    </tr>
    <tr>
      <td class='line'>775</td><td>&nbsp;</td>
      <td><pre class='comment'>                // unconditional retry recommended in 13.2.6 of RFC 2616.</pre></td>
    </tr>
    <tr>
      <td class='line'>776</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>777</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>778</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>779</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>781</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    HttpResponse negotiateResponseFromVariants(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>782</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request, final HttpContext context,</pre></td>
    </tr>
    <tr>
      <td class='line'>783</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Map&lt;String, Variant> variants) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>784</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpRequestWrapper conditionalRequest = conditionalRequestBuilder</pre></td>
    </tr>
    <tr>
      <td class='line'>785</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            .buildConditionalRequestFromVariants(request, variants);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>787</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Date requestDate = getCurrentDate();</pre></td>
    </tr>
    <tr>
      <td class='line'>788</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse backendResponse = backend.execute(target, conditionalRequest, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>789</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Date responseDate = getCurrentDate();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>791</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        backendResponse.addHeader("Via", generateViaHeader(backendResponse));</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>793</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (backendResponse.getStatusLine().getStatusCode() != HttpStatus.SC_NOT_MODIFIED) {</pre></td>
    </tr>
    <tr>
      <td class='line'>794</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return handleBackendResponse(target, request, requestDate, responseDate, backendResponse);</pre></td>
    </tr>
    <tr>
      <td class='line'>795</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>797</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Header resultEtagHeader = backendResponse.getFirstHeader(HeaderConstants.ETAG);</pre></td>
    </tr>
    <tr>
      <td class='line'>798</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (resultEtagHeader == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>799</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.warn("304 response did not contain ETag");</pre></td>
    </tr>
    <tr>
      <td class='line'>800</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return callBackend(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>801</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>803</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final String resultEtag = resultEtagHeader.getValue();</pre></td>
    </tr>
    <tr>
      <td class='line'>804</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Variant matchingVariant = variants.get(resultEtag);</pre></td>
    </tr>
    <tr>
      <td class='line'>805</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (matchingVariant == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>806</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.debug("304 response did not contain ETag matching one sent in If-None-Match");</pre></td>
    </tr>
    <tr>
      <td class='line'>807</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return callBackend(target, request, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>808</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>810</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpCacheEntry matchedEntry = matchingVariant.getEntry();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>812</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (revalidationResponseIsTooOld(backendResponse, matchedEntry)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>813</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            IOUtils.consume(backendResponse.getEntity());</pre></td>
    </tr>
    <tr>
      <td class='line'>814</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return retryRequestUnconditionally(target, request, context,</pre></td>
    </tr>
    <tr>
      <td class='line'>815</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    matchedEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>816</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>818</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        recordCacheUpdate(context);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>820</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpCacheEntry responseEntry = getUpdatedVariantEntry(target,</pre></td>
    </tr>
    <tr>
      <td class='line'>821</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                conditionalRequest, requestDate, responseDate, backendResponse,</pre></td>
    </tr>
    <tr>
      <td class='line'>822</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                matchingVariant, matchedEntry);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>824</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpResponse resp = responseGenerator.generateResponse(request, responseEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>825</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        tryToUpdateVariantMap(target, request, matchingVariant);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>827</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (shouldSendNotModifiedResponse(request, responseEntry)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>828</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return responseGenerator.generateNotModifiedResponse(responseEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>829</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>831</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return resp;</pre></td>
    </tr>
    <tr>
      <td class='line'>832</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>834</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpResponse retryRequestUnconditionally(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>835</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request, final HttpContext context,</pre></td>
    </tr>
    <tr>
      <td class='line'>836</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry matchedEntry) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>837</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpRequestWrapper unconditional = conditionalRequestBuilder</pre></td>
    </tr>
    <tr>
      <td class='line'>838</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            .buildUnconditionalRequest(request, matchedEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>839</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return callBackend(target, unconditional, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>840</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>842</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private HttpCacheEntry getUpdatedVariantEntry(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>843</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper conditionalRequest, final Date requestDate,</pre></td>
    </tr>
    <tr>
      <td class='line'>844</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Date responseDate, final HttpResponse backendResponse,</pre></td>
    </tr>
    <tr>
      <td class='line'>845</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Variant matchingVariant, final HttpCacheEntry matchedEntry) {</pre></td>
    </tr>
    <tr>
      <td class='line'>846</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpCacheEntry responseEntry = matchedEntry;</pre></td>
    </tr>
    <tr>
      <td class='line'>847</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>848</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            responseEntry = responseCache.updateVariantCacheEntry(target, conditionalRequest,</pre></td>
    </tr>
    <tr>
      <td class='line'>849</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    matchedEntry, backendResponse, requestDate, responseDate, matchingVariant.getCacheKey());</pre></td>
    </tr>
    <tr>
      <td class='line'>850</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>851</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.warn("Could not update cache entry", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>852</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>853</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return responseEntry;</pre></td>
    </tr>
    <tr>
      <td class='line'>854</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>856</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void tryToUpdateVariantMap(final HttpHost target, final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>857</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Variant matchingVariant) {</pre></td>
    </tr>
    <tr>
      <td class='line'>858</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>859</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            responseCache.reuseVariantEntryFor(target, request, matchingVariant);</pre></td>
    </tr>
    <tr>
      <td class='line'>860</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>861</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            log.warn("Could not update cache entry to reuse variant", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>862</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>863</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>865</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean shouldSendNotModifiedResponse(final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>866</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry responseEntry) {</pre></td>
    </tr>
    <tr>
      <td class='line'>867</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return (suitabilityChecker.isConditional(request)</pre></td>
    </tr>
    <tr>
      <td class='line'>868</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                && suitabilityChecker.allConditionalsMatch(request, responseEntry, new Date()));</pre></td>
    </tr>
    <tr>
      <td class='line'>869</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>871</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    HttpResponse revalidateCacheEntry(</pre></td>
    </tr>
    <tr>
      <td class='line'>872</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>873</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>874</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpContext context,</pre></td>
    </tr>
    <tr>
      <td class='line'>875</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry cacheEntry) throws IOException, ProtocolException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>877</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final HttpRequestWrapper conditionalRequest = conditionalRequestBuilder.buildConditionalRequest(request, cacheEntry);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>879</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Date requestDate = getCurrentDate();</pre></td>
    </tr>
    <tr>
      <td class='line'>880</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpResponse backendResponse = backend.execute(target, conditionalRequest, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>881</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Date responseDate = getCurrentDate();</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>883</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (revalidationResponseIsTooOld(backendResponse, cacheEntry)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>884</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            IOUtils.consume(backendResponse.getEntity());</pre></td>
    </tr>
    <tr>
      <td class='line'>885</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequest unconditional = conditionalRequestBuilder</pre></td>
    </tr>
    <tr>
      <td class='line'>886</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                .buildUnconditionalRequest(request, cacheEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>887</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            requestDate = getCurrentDate();</pre></td>
    </tr>
    <tr>
      <td class='line'>888</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            backendResponse = backend.execute(target, unconditional, context);</pre></td>
    </tr>
    <tr>
      <td class='line'>889</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            responseDate = getCurrentDate();</pre></td>
    </tr>
    <tr>
      <td class='line'>890</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>892</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        backendResponse.addHeader(HeaderConstants.VIA, generateViaHeader(backendResponse));</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>894</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final int statusCode = backendResponse.getStatusLine().getStatusCode();</pre></td>
    </tr>
    <tr>
      <td class='line'>895</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (statusCode == HttpStatus.SC_NOT_MODIFIED || statusCode == HttpStatus.SC_OK) {</pre></td>
    </tr>
    <tr>
      <td class='line'>896</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            recordCacheUpdate(context);</pre></td>
    </tr>
    <tr>
      <td class='line'>897</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>899</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (statusCode == HttpStatus.SC_NOT_MODIFIED) {</pre></td>
    </tr>
    <tr>
      <td class='line'>900</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpCacheEntry updatedEntry = responseCache.updateCacheEntry(target, request, cacheEntry,</pre></td>
    </tr>
    <tr>
      <td class='line'>901</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    backendResponse, requestDate, responseDate);</pre></td>
    </tr>
    <tr>
      <td class='line'>902</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (suitabilityChecker.isConditional(request)</pre></td>
    </tr>
    <tr>
      <td class='line'>903</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    && suitabilityChecker.allConditionalsMatch(request, updatedEntry, new Date())) {</pre></td>
    </tr>
    <tr>
      <td class='line'>904</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                return responseGenerator.generateNotModifiedResponse(updatedEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>905</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>906</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return responseGenerator.generateResponse(request, updatedEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>907</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>909</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (staleIfErrorAppliesTo(statusCode)</pre></td>
    </tr>
    <tr>
      <td class='line'>910</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            && !staleResponseNotAllowed(request, cacheEntry, getCurrentDate())</pre></td>
    </tr>
    <tr>
      <td class='line'>911</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            && validityPolicy.mayReturnStaleIfError(request, cacheEntry, responseDate)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>912</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpResponse cachedResponse = responseGenerator.generateResponse(request, cacheEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>913</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            cachedResponse.addHeader(HeaderConstants.WARNING, "110 localhost \"Response is stale\"");</pre></td>
    </tr>
    <tr>
      <td class='line'>914</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpEntity errorBody = backendResponse.getEntity();</pre></td>
    </tr>
    <tr>
      <td class='line'>915</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (errorBody != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>916</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                IOUtils.consume(errorBody);</pre></td>
    </tr>
    <tr>
      <td class='line'>917</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>918</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return cachedResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>919</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>921</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return handleBackendResponse(target, conditionalRequest, requestDate, responseDate,</pre></td>
    </tr>
    <tr>
      <td class='line'>922</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                                     backendResponse);</pre></td>
    </tr>
    <tr>
      <td class='line'>923</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>925</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean staleIfErrorAppliesTo(final int statusCode) {</pre></td>
    </tr>
    <tr>
      <td class='line'>926</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return statusCode == HttpStatus.SC_INTERNAL_SERVER_ERROR</pre></td>
    </tr>
    <tr>
      <td class='line'>927</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                || statusCode == HttpStatus.SC_BAD_GATEWAY</pre></td>
    </tr>
    <tr>
      <td class='line'>928</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                || statusCode == HttpStatus.SC_SERVICE_UNAVAILABLE</pre></td>
    </tr>
    <tr>
      <td class='line'>929</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                || statusCode == HttpStatus.SC_GATEWAY_TIMEOUT;</pre></td>
    </tr>
    <tr>
      <td class='line'>930</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>932</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    HttpResponse handleBackendResponse(</pre></td>
    </tr>
    <tr>
      <td class='line'>933</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>934</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequestWrapper request,</pre></td>
    </tr>
    <tr>
      <td class='line'>935</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Date requestDate,</pre></td>
    </tr>
    <tr>
      <td class='line'>936</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Date responseDate,</pre></td>
    </tr>
    <tr>
      <td class='line'>937</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpResponse backendResponse) throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>939</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        log.trace("Handling Backend response");</pre></td>
    </tr>
    <tr>
      <td class='line'>940</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        responseCompliance.ensureProtocolCompliance(request, backendResponse);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>942</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final boolean cacheable = responseCachingPolicy.isResponseCacheable(request, backendResponse);</pre></td>
    </tr>
    <tr>
      <td class='line'>943</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        responseCache.flushInvalidatedCacheEntriesFor(target, request, backendResponse);</pre></td>
    </tr>
    <tr>
      <td class='line'>944</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (cacheable &&</pre></td>
    </tr>
    <tr>
      <td class='line'>945</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            !alreadyHaveNewerCacheEntry(target, request, backendResponse)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>946</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>947</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                storeRequestIfModifiedSinceFor304Response(request, backendResponse);</pre></td>
    </tr>
    <tr>
      <td class='line'>948</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                return responseCache.cacheAndReturnResponse(target, request, backendResponse, requestDate,</pre></td>
    </tr>
    <tr>
      <td class='line'>949</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        responseDate);</pre></td>
    </tr>
    <tr>
      <td class='line'>950</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>951</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                log.warn("Unable to store entries in cache", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>952</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>953</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>954</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!cacheable) {</pre></td>
    </tr>
    <tr>
      <td class='line'>955</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>956</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                responseCache.flushCacheEntriesFor(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>957</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>958</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                log.warn("Unable to flush invalid cache entries", ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>959</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>960</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>961</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return backendResponse;</pre></td>
    </tr>
    <tr>
      <td class='line'>962</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>    /**
     * For 304 Not modified responses, adds a "Last-Modified" header with the
     * value of the "If-Modified-Since" header passed in the request. This
     * header is required to be able to reuse match the cache entry for
     * subsequent requests but as defined in http specifications it is not
     * included in 304 responses by backend servers. This header will not be
     * included in the resulting response.
     */</div><span>    /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>972</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void storeRequestIfModifiedSinceFor304Response(</pre></td>
    </tr>
    <tr>
      <td class='line'>973</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpRequest request, final HttpResponse backendResponse) {</pre></td>
    </tr>
    <tr>
      <td class='line'>974</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (backendResponse.getStatusLine().getStatusCode() == HttpStatus.SC_NOT_MODIFIED) {</pre></td>
    </tr>
    <tr>
      <td class='line'>975</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Header h = request.getFirstHeader("If-Modified-Since");</pre></td>
    </tr>
    <tr>
      <td class='line'>976</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (h != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>977</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                backendResponse.addHeader("Last-Modified", h.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>978</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>979</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>980</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>982</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean alreadyHaveNewerCacheEntry(final HttpHost target, final HttpRequest request,</pre></td>
    </tr>
    <tr>
      <td class='line'>983</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final HttpResponse backendResponse) {</pre></td>
    </tr>
    <tr>
      <td class='line'>984</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        HttpCacheEntry existing = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>985</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>986</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            existing = responseCache.getCacheEntry(target, request);</pre></td>
    </tr>
    <tr>
      <td class='line'>987</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>988</td><td>&nbsp;</td>
      <td><pre class='comment'>            // nop</pre></td>
    </tr>
    <tr>
      <td class='line'>989</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>990</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (existing == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>991</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>992</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>993</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Header entryDateHeader = existing.getFirstHeader(HTTP.DATE_HEADER);</pre></td>
    </tr>
    <tr>
      <td class='line'>994</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (entryDateHeader == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>995</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>996</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>997</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Header responseDateHeader = backendResponse.getFirstHeader(HTTP.DATE_HEADER);</pre></td>
    </tr>
    <tr>
      <td class='line'>998</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (responseDateHeader == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>999</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>1000</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>1001</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>1002</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Date entryDate = DateUtils.parseDate(entryDateHeader.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>1003</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final Date responseDate = DateUtils.parseDate(responseDateHeader.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>1004</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return responseDate.before(entryDate);</pre></td>
    </tr>
    <tr>
      <td class='line'>1005</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (final DateParseException e) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1006</td><td>&nbsp;</td>
      <td><pre class='comment'>            // Empty on Purpose</pre></td>
    </tr>
    <tr>
      <td class='line'>1007</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>1008</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>1009</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1011</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    static class AsynchronousValidator {</pre></td>
    </tr>
    <tr>
      <td class='line'>1012</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final CachingHttpClient cachingClient;</pre></td>
    </tr>
    <tr>
      <td class='line'>1013</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final ExecutorService executor;</pre></td>
    </tr>
    <tr>
      <td class='line'>1014</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final Set&lt;String> queued;</pre></td>
    </tr>
    <tr>
      <td class='line'>1015</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final CacheKeyGenerator cacheKeyGenerator;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1017</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final Log log = LogFactory.getLog(getClass());</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>        /**
         * Create AsynchronousValidator which will make revalidation requests
         * using the supplied {@link CachingHttpClient}, and
         * a {@link ThreadPoolExecutor} generated according to the thread
         * pool settings provided in the given {@link CacheConfig}.
         * @param cachingClient used to execute asynchronous requests
         * @param config specifies thread pool settings. See
         * {@link CacheConfig#getAsynchronousWorkersMax()},
         * {@link CacheConfig#getAsynchronousWorkersCore()},
         * {@link CacheConfig#getAsynchronousWorkerIdleLifetimeSecs()},
         * and {@link CacheConfig#getRevalidationQueueSize()}.
         */</div><span>        /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>1031</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        public AsynchronousValidator(final CachingHttpClient cachingClient,</pre></td>
    </tr>
    <tr>
      <td class='line'>1032</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final CacheConfig config) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1033</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this(cachingClient,</pre></td>
    </tr>
    <tr>
      <td class='line'>1034</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    new ThreadPoolExecutor(config.getAsynchronousWorkersCore(),</pre></td>
    </tr>
    <tr>
      <td class='line'>1035</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            config.getAsynchronousWorkersMax(),</pre></td>
    </tr>
    <tr>
      <td class='line'>1036</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            config.getAsynchronousWorkerIdleLifetimeSecs(),</pre></td>
    </tr>
    <tr>
      <td class='line'>1037</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            TimeUnit.SECONDS,</pre></td>
    </tr>
    <tr>
      <td class='line'>1038</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            new ArrayBlockingQueue&lt;Runnable>(config.getRevalidationQueueSize()))</pre></td>
    </tr>
    <tr>
      <td class='line'>1039</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    );</pre></td>
    </tr>
    <tr>
      <td class='line'>1040</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>        /**
         * Create AsynchronousValidator which will make revalidation requests
         * using the supplied {@link CachingHttpClient} and
         * {@link ExecutorService}.
         * @param cachingClient used to execute asynchronous requests
         * @param executor used to manage a thread pool of revalidation workers
         */</div><span>        /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>1049</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        AsynchronousValidator(final CachingHttpClient cachingClient,</pre></td>
    </tr>
    <tr>
      <td class='line'>1050</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final ExecutorService executor) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1051</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.cachingClient = cachingClient;</pre></td>
    </tr>
    <tr>
      <td class='line'>1052</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.executor = executor;</pre></td>
    </tr>
    <tr>
      <td class='line'>1053</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.queued = new HashSet&lt;String>();</pre></td>
    </tr>
    <tr>
      <td class='line'>1054</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.cacheKeyGenerator = new CacheKeyGenerator();</pre></td>
    </tr>
    <tr>
      <td class='line'>1055</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>        /**
         * Schedules an asynchronous revalidation
         *
         * @param target
         * @param request
         * @param context
         * @param entry
         */</div><span>        /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>1065</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        public synchronized void revalidateCacheEntry(final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>1066</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final HttpRequestWrapper request, final HttpContext context, final HttpCacheEntry entry) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1067</td><td>&nbsp;</td>
      <td><pre class='comment'>            // getVariantURI will fall back on getURI if no variants exist</pre></td>
    </tr>
    <tr>
      <td class='line'>1068</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            final String uri = cacheKeyGenerator.getVariantURI(target, request, entry);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1070</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (!queued.contains(uri)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1071</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final AsynchronousValidationRequest revalidationRequest =</pre></td>
    </tr>
    <tr>
      <td class='line'>1072</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    new AsynchronousValidationRequest(this, cachingClient, target,</pre></td>
    </tr>
    <tr>
      <td class='line'>1073</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                            request, context, entry, uri);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1075</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                try {</pre></td>
    </tr>
    <tr>
      <td class='line'>1076</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    executor.execute(revalidationRequest);</pre></td>
    </tr>
    <tr>
      <td class='line'>1077</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    queued.add(uri);</pre></td>
    </tr>
    <tr>
      <td class='line'>1078</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                } catch (final RejectedExecutionException ree) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1079</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    log.debug("Revalidation for [" + uri + "] not scheduled: " + ree);</pre></td>
    </tr>
    <tr>
      <td class='line'>1080</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                }</pre></td>
    </tr>
    <tr>
      <td class='line'>1081</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>1082</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>        /**
         * Removes an identifier from the internal list of revalidation jobs in
         * progress.  This is meant to be called by
         * {@link AsynchronousValidationRequest#run()} once the revalidation is
         * complete, using the identifier passed in during constructions.
         * @param identifier
         */</div><span>        /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>1091</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        synchronized void markComplete(final String identifier) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1092</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            queued.remove(identifier);</pre></td>
    </tr>
    <tr>
      <td class='line'>1093</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1095</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Set&lt;String> getScheduledIdentifiers() {</pre></td>
    </tr>
    <tr>
      <td class='line'>1096</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return Collections.unmodifiableSet(queued);</pre></td>
    </tr>
    <tr>
      <td class='line'>1097</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1099</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        ExecutorService getExecutor() {</pre></td>
    </tr>
    <tr>
      <td class='line'>1100</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return executor;</pre></td>
    </tr>
    <tr>
      <td class='line'>1101</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>1102</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1104</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    static class AsynchronousValidationRequest implements Runnable {</pre></td>
    </tr>
    <tr>
      <td class='line'>1105</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final AsynchronousValidator parent;</pre></td>
    </tr>
    <tr>
      <td class='line'>1106</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final CachingHttpClient cachingClient;</pre></td>
    </tr>
    <tr>
      <td class='line'>1107</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final HttpHost target;</pre></td>
    </tr>
    <tr>
      <td class='line'>1108</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final HttpRequestWrapper request;</pre></td>
    </tr>
    <tr>
      <td class='line'>1109</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final HttpContext context;</pre></td>
    </tr>
    <tr>
      <td class='line'>1110</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final HttpCacheEntry cacheEntry;</pre></td>
    </tr>
    <tr>
      <td class='line'>1111</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final String identifier;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1113</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        private final Log log = LogFactory.getLog(getClass());</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>        /**
         * Used internally by {@link AsynchronousValidator} to schedule a
         * revalidation.
         * @param cachingClient
         * @param target
         * @param request
         * @param context
         * @param cacheEntry
         * @param bookKeeping
         * @param identifier
         */</div><span>        /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>1126</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        AsynchronousValidationRequest(final AsynchronousValidator parent,</pre></td>
    </tr>
    <tr>
      <td class='line'>1127</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final CachingHttpClient cachingClient, final HttpHost target,</pre></td>
    </tr>
    <tr>
      <td class='line'>1128</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final HttpRequestWrapper request, final HttpContext context,</pre></td>
    </tr>
    <tr>
      <td class='line'>1129</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final HttpCacheEntry cacheEntry,</pre></td>
    </tr>
    <tr>
      <td class='line'>1130</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                final String identifier) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1131</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.parent = parent;</pre></td>
    </tr>
    <tr>
      <td class='line'>1132</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.cachingClient = cachingClient;</pre></td>
    </tr>
    <tr>
      <td class='line'>1133</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.target = target;</pre></td>
    </tr>
    <tr>
      <td class='line'>1134</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.request = request;</pre></td>
    </tr>
    <tr>
      <td class='line'>1135</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.context = context;</pre></td>
    </tr>
    <tr>
      <td class='line'>1136</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.cacheEntry = cacheEntry;</pre></td>
    </tr>
    <tr>
      <td class='line'>1137</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            this.identifier = identifier;</pre></td>
    </tr>
    <tr>
      <td class='line'>1138</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1140</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        public void run() {</pre></td>
    </tr>
    <tr>
      <td class='line'>1141</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>1142</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                cachingClient.revalidateCacheEntry(target, request, context, cacheEntry);</pre></td>
    </tr>
    <tr>
      <td class='line'>1143</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (final IOException ioe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1144</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                log.debug("Asynchronous revalidation failed due to exception: " + ioe);</pre></td>
    </tr>
    <tr>
      <td class='line'>1145</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (final ProtocolException pe) {</pre></td>
    </tr>
    <tr>
      <td class='line'>1146</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                log.error("ProtocolException thrown during asynchronous revalidation: " + pe);</pre></td>
    </tr>
    <tr>
      <td class='line'>1147</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } finally {</pre></td>
    </tr>
    <tr>
      <td class='line'>1148</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                parent.markComplete(identifier);</pre></td>
    </tr>
    <tr>
      <td class='line'>1149</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>1150</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1152</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        String getIdentifier() {</pre></td>
    </tr>
    <tr>
      <td class='line'>1153</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return identifier;</pre></td>
    </tr>
    <tr>
      <td class='line'>1154</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1156</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>1158</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>}</pre></td>
    </tr>
  </table>
</body>
</html>
