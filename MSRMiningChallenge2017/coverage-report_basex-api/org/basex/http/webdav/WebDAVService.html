<!DOCTYPE html>
<html>
<head>
  <title>WebDAVService.java</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../../../../coverage.css'/>
  <link rel='shortcut icon' type='image/png' href='../../../../logo.png'/>
  <script type='text/javascript' src='../../../../coverage.js'></script>
  <script type='text/javascript' src='../../../../prettify.js'></script>
</head>
<body onload='prettyPrint()'>
  <table cellpadding='0' cellspacing='1'>
    <caption>basex-api/src/main/java/org/basex/http/webdav/WebDAVService.java</caption>
    <tr>
      <td class='line'>1</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>package org.basex.http.webdav;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td><pre class='imports prettyprint' onclick='showHideLines(this)'><div>import static org.basex.http.webdav.WebDAVUtils.*;
import static org.basex.query.func.Function.*;

import java.io.*;
import java.util.*;
import java.util.Map.Entry;
import java.util.List;

import org.basex.api.client.*;
import org.basex.core.*;
import org.basex.core.cmd.*;
import org.basex.core.cmd.Set;
import org.basex.http.*;
import org.basex.io.in.*;
import org.basex.io.serial.*;
import org.basex.query.func.db.*;
import org.basex.util.*;
import org.basex.util.http.*;
import org.basex.util.list.*;
</div><span>import ...</span></pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>/**
 * Service handling the various WebDAV operations.
 *
 * @author BaseX Team 2005-16, BSD License
 * @author Dimitar Popov
 */</div><span>/*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>29</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>final class WebDAVService {</pre></td>
    </tr>
    <tr>
      <td class='line'>30</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** Name of the database with the WebDAV locks. */</pre></td>
    </tr>
    <tr>
      <td class='line'>31</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private static final String WEBDAV_DB = "~webdav";</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>33</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** HTTP context. */</pre></td>
    </tr>
    <tr>
      <td class='line'>34</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  final HTTPContext http;</pre></td>
    </tr>
    <tr>
      <td class='line'>35</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** Locking service. */</pre></td>
    </tr>
    <tr>
      <td class='line'>36</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  final WebDAVLockService locking;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>38</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** Session. */</pre></td>
    </tr>
    <tr>
      <td class='line'>39</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private LocalSession ls;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Constructor.
   * @param http http context
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>45</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVService(final HTTPContext http) {</pre></td>
    </tr>
    <tr>
      <td class='line'>46</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    this.http = http;</pre></td>
    </tr>
    <tr>
      <td class='line'>47</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    locking = new WebDAVLockService(http);</pre></td>
    </tr>
    <tr>
      <td class='line'>48</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Closes an open session.
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>53</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void close() {</pre></td>
    </tr>
    <tr>
      <td class='line'>54</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(ls != null) ls.close();</pre></td>
    </tr>
    <tr>
      <td class='line'>55</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Authenticates the user with the given password.
   * @param user user name
   * @param pass password
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>63</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void authenticate(final String user, final String pass) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>64</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    http.credentials(user, pass);</pre></td>
    </tr>
    <tr>
      <td class='line'>65</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session();</pre></td>
    </tr>
    <tr>
      <td class='line'>66</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Checks if the user is authorized to perform the given action.
   * @param db database (can be {@code null})
   * @return {@code true} if the user is authorized
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>73</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  static boolean authorize(final String db) {</pre></td>
    </tr>
    <tr>
      <td class='line'>74</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return !WEBDAV_DB.equals(db);</pre></td>
    </tr>
    <tr>
      <td class='line'>75</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Checks a folder for a dummy document and delete it.
   * @param db database
   * @param path path
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>83</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void deleteDummy(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>84</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String dummy = path + SEP + DUMMY;</pre></td>
    </tr>
    <tr>
      <td class='line'>85</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(!pathExists(db, dummy)) return;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>87</td><td>&nbsp;</td>
      <td><pre class='comment'>    // path contains dummy document</pre></td>
    </tr>
    <tr>
      <td class='line'>88</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>89</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>90</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Delete(dummy));</pre></td>
    </tr>
    <tr>
      <td class='line'>91</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Checks if the specified database exists.
   * @param db database to be found
   * @return result of check
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>99</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  boolean dbExists(final String db) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>100</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(_DB_EXISTS.args("$db")).bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>101</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return execute(query).equals(Text.TRUE);</pre></td>
    </tr>
    <tr>
      <td class='line'>102</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Retrieves the last modified timestamp of a database.
   * @param db database
   * @return timestamp in milliseconds.
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>110</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  long timestamp(final String db) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>111</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(DATA.args(_DB_INFO.args("$db") +</pre></td>
    </tr>
    <tr>
      <td class='line'>112</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        "/descendant::" + DbFn.toName(Text.TIMESTAMP) + "[1]")).bind("db",  db);</pre></td>
    </tr>
    <tr>
      <td class='line'>113</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return DateTime.parse(execute(query)).getTime();</pre></td>
    </tr>
    <tr>
      <td class='line'>114</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Retrieves meta data about the resource at the given path.
   * @param db database
   * @param path resource path
   * @return resource meta data
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>123</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private WebDAVMetaData metaData(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>124</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(</pre></td>
    </tr>
    <tr>
      <td class='line'>125</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "let $a := " + _DB_LIST_DETAILS.args("$db", "$path") + "[1] " +</pre></td>
    </tr>
    <tr>
      <td class='line'>126</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "return string-join(($a/@raw, $a/@content-type, $a/@modified-date, $a/@size, $a),out:tab())");</pre></td>
    </tr>
    <tr>
      <td class='line'>127</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>128</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>130</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String[] result = results(query);</pre></td>
    </tr>
    <tr>
      <td class='line'>131</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final boolean raw = Boolean.parseBoolean(result[0]);</pre></td>
    </tr>
    <tr>
      <td class='line'>132</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final MediaType type = new MediaType(result[1]);</pre></td>
    </tr>
    <tr>
      <td class='line'>133</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final long mod = DateTime.parse(result[2]).getTime();</pre></td>
    </tr>
    <tr>
      <td class='line'>134</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final Long size = raw ? Long.valueOf(result[3]) : null;</pre></td>
    </tr>
    <tr>
      <td class='line'>135</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String pth = stripLeadingSlash(result[4]);</pre></td>
    </tr>
    <tr>
      <td class='line'>136</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return new WebDAVMetaData(db, pth, mod, raw, type, size);</pre></td>
    </tr>
    <tr>
      <td class='line'>137</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Deletes a document or folder.
   * @param db database
   * @param path path
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>145</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void delete(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>146</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>147</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>148</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Delete(path));</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>150</td><td>&nbsp;</td>
      <td><pre class='comment'>    // create dummy if parent is an empty folder</pre></td>
    </tr>
    <tr>
      <td class='line'>151</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final int ix = path.lastIndexOf(SEP);</pre></td>
    </tr>
    <tr>
      <td class='line'>152</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(ix > 0) createDummy(db, path.substring(0, ix));</pre></td>
    </tr>
    <tr>
      <td class='line'>153</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Renames a document or folder.
   * @param db database
   * @param path path
   * @param npath new path
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>162</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void rename(final String db, final String path, final String npath) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>163</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>164</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>165</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Rename(path, npath));</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>167</td><td>&nbsp;</td>
      <td><pre class='comment'>    // create dummy if old parent is an empty folder</pre></td>
    </tr>
    <tr>
      <td class='line'>168</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final int i1 = path.lastIndexOf(SEP);</pre></td>
    </tr>
    <tr>
      <td class='line'>169</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(i1 > 0) createDummy(db, path.substring(0, i1));</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>171</td><td>&nbsp;</td>
      <td><pre class='comment'>    // delete dummy if new parent is an empty folder</pre></td>
    </tr>
    <tr>
      <td class='line'>172</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final int i2 = npath.lastIndexOf(SEP);</pre></td>
    </tr>
    <tr>
      <td class='line'>173</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(i2 > 0) deleteDummy(db, npath.substring(0, i2));</pre></td>
    </tr>
    <tr>
      <td class='line'>174</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Copies a document to the specified target.
   * @param db source database
   * @param path source path
   * @param tdb target database
   * @param tpath target path
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>184</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void copyDoc(final String db, final String path, final String tdb, final String tpath)</pre></td>
    </tr>
    <tr>
      <td class='line'>185</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>187</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(</pre></td>
    </tr>
    <tr>
      <td class='line'>188</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "declare option db:chop 'false';" +</pre></td>
    </tr>
    <tr>
      <td class='line'>189</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "if(" + _DB_IS_RAW.args("$db", "$path") + ')' +</pre></td>
    </tr>
    <tr>
      <td class='line'>190</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      " then " + _DB_STORE.args("$tdb", "$tpath", _DB_RETRIEVE.args("$db", "$path")) +</pre></td>
    </tr>
    <tr>
      <td class='line'>191</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      " else " + _DB_ADD.args("$tdb", _DB_OPEN.args("$db", "$path"), "$tpath"));</pre></td>
    </tr>
    <tr>
      <td class='line'>192</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>193</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr>
      <td class='line'>194</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("tdb", tdb);</pre></td>
    </tr>
    <tr>
      <td class='line'>195</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("tpath", tpath);</pre></td>
    </tr>
    <tr>
      <td class='line'>196</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    execute(query);</pre></td>
    </tr>
    <tr>
      <td class='line'>197</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Copies all documents in a folder to another folder.
   * @param db source database
   * @param path source path
   * @param tdb target database
   * @param tpath target folder
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>207</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void copyAll(final String db, final String path, final String tdb, final String tpath)</pre></td>
    </tr>
    <tr>
      <td class='line'>208</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>210</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(</pre></td>
    </tr>
    <tr>
      <td class='line'>211</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "declare option db:chop 'false'; " +</pre></td>
    </tr>
    <tr>
      <td class='line'>212</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "for $d in " + _DB_LIST.args("$db", "$path") +</pre></td>
    </tr>
    <tr>
      <td class='line'>213</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "let $t := $tpath ||'/'|| substring($d, string-length($path) + 1) return " +</pre></td>
    </tr>
    <tr>
      <td class='line'>214</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "if(" + _DB_IS_RAW.args("$db", "$d") + ") " +</pre></td>
    </tr>
    <tr>
      <td class='line'>215</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "then " + _DB_STORE.args("$tdb", "$t", _DB_RETRIEVE.args("$db", "$d")) +</pre></td>
    </tr>
    <tr>
      <td class='line'>216</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      " else " + _DB_ADD.args("$tdb", _DB_OPEN.args("$db", "$d"), "$t"));</pre></td>
    </tr>
    <tr>
      <td class='line'>217</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>218</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr>
      <td class='line'>219</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("tdb", tdb);</pre></td>
    </tr>
    <tr>
      <td class='line'>220</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("tpath", tpath);</pre></td>
    </tr>
    <tr>
      <td class='line'>221</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    execute(query);</pre></td>
    </tr>
    <tr>
      <td class='line'>222</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Writes a file to the specified output stream.
   * @param db database
   * @param path path
   * @param raw is the file a raw file
   * @param out output stream
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>232</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void retrieve(final String db, final String path, final boolean raw, final OutputStream out)</pre></td>
    </tr>
    <tr>
      <td class='line'>233</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>235</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session().setOutputStream(out);</pre></td>
    </tr>
    <tr>
      <td class='line'>236</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String string = SerializerOptions.USE_CHARACTER_MAPS.arg("&#xA0;=&amp;#xA0;") +</pre></td>
    </tr>
    <tr>
      <td class='line'>237</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        (raw ? _DB_RETRIEVE : _DB_OPEN).args("$db", "$path") + "[1]";</pre></td>
    </tr>
    <tr>
      <td class='line'>238</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(string);</pre></td>
    </tr>
    <tr>
      <td class='line'>239</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>240</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr>
      <td class='line'>241</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    execute(query);</pre></td>
    </tr>
    <tr>
      <td class='line'>242</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Creates an empty database with the given name.
   * @param db database name
   * @return object representing the newly created database
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>250</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVResource createDb(final String db) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>251</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session().execute(new CreateDB(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>252</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return WebDAVFactory.database(this, new WebDAVMetaData(db, timestamp(db)));</pre></td>
    </tr>
    <tr>
      <td class='line'>253</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Drops the database with the given name.
   * @param db database name
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>260</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void dropDb(final String db) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>261</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session().execute(new DropDB(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>262</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Renames the database with the given name.
   * @param old database name
   * @param db new name
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>270</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void renameDb(final String old, final String db) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>271</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session().execute(new AlterDB(old, dbName(db)));</pre></td>
    </tr>
    <tr>
      <td class='line'>272</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Copies the database with the given name.
   * @param old database name
   * @param db new database name
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>280</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void copyDb(final String old, final String db) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>281</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session().execute(new Copy(old, dbName(db)));</pre></td>
    </tr>
    <tr>
      <td class='line'>282</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Lists the direct children of a path.
   * @param db database
   * @param path path
   * @return children
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>291</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  List&lt;WebDAVResource> list(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>292</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(STRING_JOIN.args(</pre></td>
    </tr>
    <tr>
      <td class='line'>293</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      _DB_LIST_DETAILS.args("$db", "$path") + " ! (" +</pre></td>
    </tr>
    <tr>
      <td class='line'>294</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "@raw,@content-type,@modified-date,@size," + SUBSTRING_AFTER.args("text()", "$path") + ')',</pre></td>
    </tr>
    <tr>
      <td class='line'>295</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      "out:tab()"));</pre></td>
    </tr>
    <tr>
      <td class='line'>296</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>297</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr>
      <td class='line'>298</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String[] result = results(query);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>300</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final HashSet&lt;String> paths = new HashSet&lt;>();</pre></td>
    </tr>
    <tr>
      <td class='line'>301</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final List&lt;WebDAVResource> ch = new ArrayList&lt;>();</pre></td>
    </tr>
    <tr>
      <td class='line'>302</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final int rs = result.length;</pre></td>
    </tr>
    <tr>
      <td class='line'>303</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    for(int r = 0; r &lt; rs; r += 5) {</pre></td>
    </tr>
    <tr>
      <td class='line'>304</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final boolean raw = Boolean.parseBoolean(result[r]);</pre></td>
    </tr>
    <tr>
      <td class='line'>305</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final MediaType ctype = new MediaType(result[r + 1]);</pre></td>
    </tr>
    <tr>
      <td class='line'>306</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final long mod = DateTime.parse(result[r + 2]).getTime();</pre></td>
    </tr>
    <tr>
      <td class='line'>307</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final Long size = raw ? Long.valueOf(result[r + 3]) : null;</pre></td>
    </tr>
    <tr>
      <td class='line'>308</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final String pth = stripLeadingSlash(result[r + 4]);</pre></td>
    </tr>
    <tr>
      <td class='line'>309</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final int ix = pth.indexOf(SEP);</pre></td>
    </tr>
    <tr>
      <td class='line'>310</td><td>&nbsp;</td>
      <td><pre class='comment'>      // check if document or folder</pre></td>
    </tr>
    <tr>
      <td class='line'>311</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      if(ix &lt; 0) {</pre></td>
    </tr>
    <tr>
      <td class='line'>312</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if(!pth.equals(DUMMY)) ch.add(WebDAVFactory.file(this,</pre></td>
    </tr>
    <tr>
      <td class='line'>313</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          new WebDAVMetaData(db, path + SEP + pth, mod, raw, ctype, size)));</pre></td>
    </tr>
    <tr>
      <td class='line'>314</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>315</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final String dir = path + SEP + pth.substring(0, ix);</pre></td>
    </tr>
    <tr>
      <td class='line'>316</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if(paths.add(dir)) ch.add(WebDAVFactory.folder(this, new WebDAVMetaData(db, dir, mod)));</pre></td>
    </tr>
    <tr>
      <td class='line'>317</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>318</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>319</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return ch;</pre></td>
    </tr>
    <tr>
      <td class='line'>320</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Lists all databases.
   * @return a list of database resources.
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>327</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  List&lt;WebDAVResource> listDbs() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>328</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(STRING_JOIN.args(</pre></td>
    </tr>
    <tr>
      <td class='line'>329</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        _DB_LIST_DETAILS.args() + "[. != $db] ! (text(), @modified-date)", "out:tab()"));</pre></td>
    </tr>
    <tr>
      <td class='line'>330</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", WEBDAV_DB);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>332</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String[] result = results(query);</pre></td>
    </tr>
    <tr>
      <td class='line'>333</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final List&lt;WebDAVResource> dbs = new ArrayList&lt;>();</pre></td>
    </tr>
    <tr>
      <td class='line'>334</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final int rs = result.length;</pre></td>
    </tr>
    <tr>
      <td class='line'>335</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    for(int r = 0; r &lt; rs; r += 2) {</pre></td>
    </tr>
    <tr>
      <td class='line'>336</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final String name = result[r];</pre></td>
    </tr>
    <tr>
      <td class='line'>337</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final long mod = DateTime.parse(result[r + 1]).getTime();</pre></td>
    </tr>
    <tr>
      <td class='line'>338</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      dbs.add(WebDAVFactory.database(this, new WebDAVMetaData(name, mod)));</pre></td>
    </tr>
    <tr>
      <td class='line'>339</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>340</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return dbs;</pre></td>
    </tr>
    <tr>
      <td class='line'>341</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Creates a folder at the given path.
   * @param db database
   * @param path path
   * @param name new folder name
   * @return new folder resource
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>351</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVResource createFolder(final String db, final String path, final String name)</pre></td>
    </tr>
    <tr>
      <td class='line'>352</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>354</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    deleteDummy(db, path);</pre></td>
    </tr>
    <tr>
      <td class='line'>355</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String newFolder = path + SEP + name;</pre></td>
    </tr>
    <tr>
      <td class='line'>356</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    createDummy(db, newFolder);</pre></td>
    </tr>
    <tr>
      <td class='line'>357</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return WebDAVFactory.folder(this, new WebDAVMetaData(db, newFolder, timestamp(db)));</pre></td>
    </tr>
    <tr>
      <td class='line'>358</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Gets the resource at the given path.
   * @param db database
   * @param path path
   * @return resource
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>367</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVResource resource(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>368</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return exists(db, path) ?</pre></td>
    </tr>
    <tr>
      <td class='line'>369</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      WebDAVFactory.file(this, metaData(db, path)) :</pre></td>
    </tr>
    <tr>
      <td class='line'>370</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      pathExists(db, path) ?</pre></td>
    </tr>
    <tr>
      <td class='line'>371</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        WebDAVFactory.folder(this, new WebDAVMetaData(db, path, timestamp(db))) :</pre></td>
    </tr>
    <tr>
      <td class='line'>372</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        null;</pre></td>
    </tr>
    <tr>
      <td class='line'>373</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Adds the given file to the specified path.
   * @param db database
   * @param path path
   * @param name file name
   * @param in file content
   * @return object representing the newly added file
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>384</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVResource createFile(final String db, final String path, final String name,</pre></td>
    </tr>
    <tr>
      <td class='line'>385</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final InputStream in) throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>387</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>388</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>389</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String dbp = path.isEmpty() ? name : path + SEP + name;</pre></td>
    </tr>
    <tr>
      <td class='line'>390</td><td>&nbsp;</td>
      <td><pre class='comment'>    // delete old resource if it already exists</pre></td>
    </tr>
    <tr>
      <td class='line'>391</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(pathExists(db, dbp)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>392</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>393</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      session.execute(new Delete(dbp));</pre></td>
    </tr>
    <tr>
      <td class='line'>394</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>395</td><td>&nbsp;</td>
      <td><pre class='comment'>      // otherwise, delete dummy file</pre></td>
    </tr>
    <tr>
      <td class='line'>396</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      deleteDummy(db, path);</pre></td>
    </tr>
    <tr>
      <td class='line'>397</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>398</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return addFile(db, dbp, in);</pre></td>
    </tr>
    <tr>
      <td class='line'>399</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Creates a new database from the given file.
   * @param n file name
   * @param in file content
   * @return object representing the newly created database
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>408</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVResource createFile(final String n, final InputStream in) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>409</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return addFile(null, n, in);</pre></td>
    </tr>
    <tr>
      <td class='line'>410</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Checks if any of the resources starts with the given path.
   * @param db name of database
   * @param path path
   * @return {@code true} if there are resources with the given prefix
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>419</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private boolean pathExists(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>420</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(EXISTS.args(_DB_LIST.args("$db", "$path")));</pre></td>
    </tr>
    <tr>
      <td class='line'>421</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>422</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr>
      <td class='line'>423</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return execute(query).equals(Text.TRUE);</pre></td>
    </tr>
    <tr>
      <td class='line'>424</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Checks if any resource with the specified name exists.
   * @param db name of database
   * @param path resource path
   * @return {@code true} if there are resources with the name
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>433</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private boolean exists(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>434</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final WebDAVQuery query = new WebDAVQuery(_DB_EXISTS.args("$db", "$path"));</pre></td>
    </tr>
    <tr>
      <td class='line'>435</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("db", db);</pre></td>
    </tr>
    <tr>
      <td class='line'>436</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    query.bind("path", path);</pre></td>
    </tr>
    <tr>
      <td class='line'>437</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return execute(query).equals(Text.TRUE);</pre></td>
    </tr>
    <tr>
      <td class='line'>438</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Creates a database with the given name and add the given document.
   * @param db database name
   * @param in data stream
   * @return object representing the newly created database
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>447</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private WebDAVResource createDb(final String db, final InputStream in) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>448</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session().create(db, in);</pre></td>
    </tr>
    <tr>
      <td class='line'>449</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return WebDAVFactory.database(this, new WebDAVMetaData(db, timestamp(db)));</pre></td>
    </tr>
    <tr>
      <td class='line'>450</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Adds a document with the specified name to the given path.
   * @param db database
   * @param path path where the document will be added
   * @param in data stream
   * @return object representing the newly added XML
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>460</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private WebDAVResource addXML(final String db, final String path, final InputStream in)</pre></td>
    </tr>
    <tr>
      <td class='line'>461</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>463</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>464</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Set(MainOptions.CHOP, false));</pre></td>
    </tr>
    <tr>
      <td class='line'>465</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>466</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.add(path, in);</pre></td>
    </tr>
    <tr>
      <td class='line'>467</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return WebDAVFactory.file(this, new WebDAVMetaData(db, path, timestamp(db), false,</pre></td>
    </tr>
    <tr>
      <td class='line'>468</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      MediaType.APPLICATION_XML, null));</pre></td>
    </tr>
    <tr>
      <td class='line'>469</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Adds a binary file with the specified name to the given path.
   * @param db database
   * @param path path where the file will be stored
   * @param in data stream
   * @return object representing the newly added file
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>479</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private WebDAVResource store(final String db, final String path, final InputStream in)</pre></td>
    </tr>
    <tr>
      <td class='line'>480</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>482</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>483</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>484</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.store(path, in);</pre></td>
    </tr>
    <tr>
      <td class='line'>485</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return WebDAVFactory.file(this, metaData(db, path));</pre></td>
    </tr>
    <tr>
      <td class='line'>486</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Adds a file in to the given path.
   * @param db database
   * @param path path
   * @param in file content
   * @return object representing the newly added file
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>496</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private WebDAVResource addFile(final String db, final String path, final InputStream in)</pre></td>
    </tr>
    <tr>
      <td class='line'>497</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws IOException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>499</td><td>&nbsp;</td>
      <td><pre class='comment'>    // use 4MB as buffer input</pre></td>
    </tr>
    <tr>
      <td class='line'>500</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    try(final BufferInput bi = new BufferInput(in, 1 &lt;&lt; 22)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>501</td><td>&nbsp;</td>
      <td><pre class='comment'>      // guess the content type from the first character</pre></td>
    </tr>
    <tr>
      <td class='line'>502</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      if(peek(bi) == '&lt;') {</pre></td>
    </tr>
    <tr>
      <td class='line'>503</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>504</td><td>&nbsp;</td>
      <td><pre class='comment'>          // add input as XML document</pre></td>
    </tr>
    <tr>
      <td class='line'>505</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          return db == null ? createDb(dbName(path), bi) : addXML(db, path, bi);</pre></td>
    </tr>
    <tr>
      <td class='line'>506</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch(final IOException ex) {</pre></td>
    </tr>
    <tr>
      <td class='line'>507</td><td>&nbsp;</td>
      <td><pre class='comment'>          // reset stream if it did not work out</pre></td>
    </tr>
    <tr>
      <td class='line'>508</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          try {</pre></td>
    </tr>
    <tr>
      <td class='line'>509</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            bi.reset();</pre></td>
    </tr>
    <tr>
      <td class='line'>510</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          } catch(final IOException e) {</pre></td>
    </tr>
    <tr>
      <td class='line'>511</td><td>&nbsp;</td>
      <td><pre class='comment'>            // throw original exception if input cannot be reset</pre></td>
    </tr>
    <tr>
      <td class='line'>512</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw ex;</pre></td>
    </tr>
    <tr>
      <td class='line'>513</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          }</pre></td>
    </tr>
    <tr>
      <td class='line'>514</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>515</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>517</td><td>&nbsp;</td>
      <td><pre class='comment'>      // add input as raw file</pre></td>
    </tr>
    <tr>
      <td class='line'>518</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final String d;</pre></td>
    </tr>
    <tr>
      <td class='line'>519</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      if(db == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>520</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        d = dbName(path);</pre></td>
    </tr>
    <tr>
      <td class='line'>521</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        createDb(d);</pre></td>
    </tr>
    <tr>
      <td class='line'>522</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>523</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        d = db;</pre></td>
    </tr>
    <tr>
      <td class='line'>524</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>525</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      return store(d, path, bi);</pre></td>
    </tr>
    <tr>
      <td class='line'>526</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>527</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Checks if a folder is empty and create a dummy document.
   * @param db database
   * @param path path
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>535</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private void createDummy(final String db, final String path) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>536</td><td>&nbsp;</td>
      <td><pre class='comment'>    // check if path is a folder and is empty</pre></td>
    </tr>
    <tr>
      <td class='line'>537</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(path.matches("[^/]") || pathExists(db, path)) return;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>539</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LocalSession session = session();</pre></td>
    </tr>
    <tr>
      <td class='line'>540</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.execute(new Open(db));</pre></td>
    </tr>
    <tr>
      <td class='line'>541</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    session.store(path + SEP + DUMMY, new ArrayInput(Token.EMPTY));</pre></td>
    </tr>
    <tr>
      <td class='line'>542</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Executes a query.
   * @param query query to be executed
   * @return result
   * @throws IOException error during query execution
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>550</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private String execute(final WebDAVQuery query) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>551</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final XQuery xquery = new XQuery(query.toString());</pre></td>
    </tr>
    <tr>
      <td class='line'>552</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    for(final Entry&lt;String, String> entry : query.entries()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>553</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      xquery.bind(entry.getKey(), entry.getValue());</pre></td>
    </tr>
    <tr>
      <td class='line'>554</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>555</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return session().execute(xquery);</pre></td>
    </tr>
    <tr>
      <td class='line'>556</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Executes a query and returns all results as a list.
   * @param query query to be executed
   * @return result
   * @throws IOException error during query execution
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>564</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private String[] results(final WebDAVQuery query) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>565</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final StringList sl = new StringList();</pre></td>
    </tr>
    <tr>
      <td class='line'>566</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    for(final String result : Strings.split(execute(query), '\t')) {</pre></td>
    </tr>
    <tr>
      <td class='line'>567</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      if(!result.isEmpty()) sl.add(result);</pre></td>
    </tr>
    <tr>
      <td class='line'>568</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>569</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return sl.finish();</pre></td>
    </tr>
    <tr>
      <td class='line'>570</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Constructor.
   * @return local session
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>577</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private LocalSession session() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>578</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(ls == null) ls = new LocalSession(http.context(true));</pre></td>
    </tr>
    <tr>
      <td class='line'>579</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return ls;</pre></td>
    </tr>
    <tr>
      <td class='line'>580</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr>
      <td class='line'>581</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>}</pre></td>
    </tr>
  </table>
</body>
</html>
