<!DOCTYPE html>
<html>
<head>
  <title>WebDAVResource.java</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../../../../coverage.css'/>
  <link rel='shortcut icon' type='image/png' href='../../../../logo.png'/>
  <script type='text/javascript' src='../../../../coverage.js'></script>
  <script type='text/javascript' src='../../../../prettify.js'></script>
</head>
<body onload='prettyPrint()'>
  <table cellpadding='0' cellspacing='1'>
    <caption>basex-api/src/main/java/org/basex/http/webdav/WebDAVResource.java</caption>
    <tr>
      <td class='line'>1</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>package org.basex.http.webdav;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td><pre class='imports prettyprint' onclick='showHideLines(this)'><div>import static com.bradmcevoy.http.LockResult.*;
import static org.basex.http.webdav.WebDAVUtils.*;

import java.io.*;
import java.util.*;

import com.bradmcevoy.http.LockInfo.LockDepth;
import com.bradmcevoy.http.LockInfo.LockScope;
import com.bradmcevoy.http.LockInfo.LockType;
import com.bradmcevoy.http.Request.Method;

import org.basex.core.StaticOptions.AuthMethod;
import org.basex.http.*;
import org.basex.util.*;
import org.xml.sax.*;
import org.xml.sax.helpers.*;

import com.bradmcevoy.http.*;
import com.bradmcevoy.http.exceptions.*;
</div><span>import ...</span></pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>/**
 * WebDAV resource representing an abstract folder within a collection database.
 *
 * @author BaseX Team 2005-16, BSD License
 * @author Rositsa Shadura
 * @author Dimitar Popov
 */</div><span>/*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>30</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>abstract class WebDAVResource implements CopyableResource, DeletableResource, MoveableResource,</pre></td>
    </tr>
    <tr>
      <td class='line'>31</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    LockableResource {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>33</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** Resource meta data. */</pre></td>
    </tr>
    <tr>
      <td class='line'>34</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  final WebDAVMetaData meta;</pre></td>
    </tr>
    <tr>
      <td class='line'>35</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** WebDAV service implementation. */</pre></td>
    </tr>
    <tr>
      <td class='line'>36</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  final WebDAVService service;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Constructor.
   * @param meta resource meta data
   * @param service service
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>43</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  WebDAVResource(final WebDAVMetaData meta, final WebDAVService service) {</pre></td>
    </tr>
    <tr>
      <td class='line'>44</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    this.meta = meta;</pre></td>
    </tr>
    <tr>
      <td class='line'>45</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    this.service = service;</pre></td>
    </tr>
    <tr>
      <td class='line'>46</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>48</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>49</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public Object authenticate(final String user, final String pass) {</pre></td>
    </tr>
    <tr>
      <td class='line'>50</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(user == null) return null;</pre></td>
    </tr>
    <tr>
      <td class='line'>51</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return new WebDAVCode&lt;Object>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>52</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>53</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public String get() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>54</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        service.authenticate(user, pass);</pre></td>
    </tr>
    <tr>
      <td class='line'>55</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return user;</pre></td>
    </tr>
    <tr>
      <td class='line'>56</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>57</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.evalNoEx();</pre></td>
    </tr>
    <tr>
      <td class='line'>58</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>60</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>61</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public boolean authorise(final Request request, final Method method, final Auth auth) {</pre></td>
    </tr>
    <tr>
      <td class='line'>62</td><td>&nbsp;</td>
      <td><pre class='comment'>    // use WebDAV authorization if no default user exists or if digest authentication is specified</pre></td>
    </tr>
    <tr>
      <td class='line'>63</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final HTTPContext http = service.http;</pre></td>
    </tr>
    <tr>
      <td class='line'>64</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(http.username.isEmpty() || http.auth == AuthMethod.DIGEST) {</pre></td>
    </tr>
    <tr>
      <td class='line'>65</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      if(auth == null || auth.getTag() == null) return false;</pre></td>
    </tr>
    <tr>
      <td class='line'>66</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>67</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return WebDAVService.authorize(meta.db);</pre></td>
    </tr>
    <tr>
      <td class='line'>68</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>70</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>71</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public String checkRedirect(final Request request) {</pre></td>
    </tr>
    <tr>
      <td class='line'>72</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return null;</pre></td>
    </tr>
    <tr>
      <td class='line'>73</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>75</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>76</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public String getRealm() {</pre></td>
    </tr>
    <tr>
      <td class='line'>77</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return Prop.NAME;</pre></td>
    </tr>
    <tr>
      <td class='line'>78</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>80</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>81</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public String getUniqueId() {</pre></td>
    </tr>
    <tr>
      <td class='line'>82</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return null;</pre></td>
    </tr>
    <tr>
      <td class='line'>83</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>85</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>86</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public String getName() {</pre></td>
    </tr>
    <tr>
      <td class='line'>87</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return name(meta.path);</pre></td>
    </tr>
    <tr>
      <td class='line'>88</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>90</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>91</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public Date getModifiedDate() {</pre></td>
    </tr>
    <tr>
      <td class='line'>92</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return meta.mdate;</pre></td>
    </tr>
    <tr>
      <td class='line'>93</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>95</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>96</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public void delete() throws BadRequestException, NotAuthorizedException {</pre></td>
    </tr>
    <tr>
      <td class='line'>97</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    new WebDAVCode&lt;Object>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>98</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>99</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public void run() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>100</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        del();</pre></td>
    </tr>
    <tr>
      <td class='line'>101</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>102</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.eval();</pre></td>
    </tr>
    <tr>
      <td class='line'>103</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>105</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>106</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public void copyTo(final CollectionResource target, final String name) throws BadRequestException,</pre></td>
    </tr>
    <tr>
      <td class='line'>107</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      NotAuthorizedException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>109</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    new WebDAVCode&lt;Object>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>110</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>111</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public void run() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>112</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if(target instanceof WebDAVRoot)</pre></td>
    </tr>
    <tr>
      <td class='line'>113</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          copyToRoot(name);</pre></td>
    </tr>
    <tr>
      <td class='line'>114</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        else if(target instanceof WebDAVFolder)</pre></td>
    </tr>
    <tr>
      <td class='line'>115</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          copyTo((WebDAVFolder) target, name);</pre></td>
    </tr>
    <tr>
      <td class='line'>116</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>117</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.eval();</pre></td>
    </tr>
    <tr>
      <td class='line'>118</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>120</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>121</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public void moveTo(final CollectionResource target, final String name) throws BadRequestException,</pre></td>
    </tr>
    <tr>
      <td class='line'>122</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      NotAuthorizedException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>124</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    new WebDAVCode&lt;Object>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>125</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>126</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public void run() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>127</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if(target instanceof WebDAVRoot)</pre></td>
    </tr>
    <tr>
      <td class='line'>128</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          moveToRoot(name);</pre></td>
    </tr>
    <tr>
      <td class='line'>129</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        else if(target instanceof WebDAVFolder)</pre></td>
    </tr>
    <tr>
      <td class='line'>130</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>          moveTo((WebDAVFolder) target, name);</pre></td>
    </tr>
    <tr>
      <td class='line'>131</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>132</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.eval();</pre></td>
    </tr>
    <tr>
      <td class='line'>133</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Lock this resource and return a token.
   *
   * @param timeout - in seconds, or null
   * @param lockInfo lock info
   * @return - a result containing the token representing the lock if successful,
   * otherwise a failure reason code
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>143</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>144</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public LockResult lock(final LockTimeout timeout, final LockInfo lockInfo)</pre></td>
    </tr>
    <tr>
      <td class='line'>145</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      throws NotAuthorizedException, PreConditionFailedException, LockedException {</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>147</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return new WebDAVCode&lt;LockResult>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>148</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>149</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public LockResult get() {</pre></td>
    </tr>
    <tr>
      <td class='line'>150</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return lockResource(timeout, lockInfo);</pre></td>
    </tr>
    <tr>
      <td class='line'>151</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>152</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.evalNoEx();</pre></td>
    </tr>
    <tr>
      <td class='line'>153</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Renew the lock and return new lock info.
   *
   * @param token lock token
   * @return lock result
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>161</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>162</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public LockResult refreshLock(final String token) throws NotAuthorizedException,</pre></td>
    </tr>
    <tr>
      <td class='line'>163</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      PreConditionFailedException {</pre></td>
    </tr>
    <tr>
      <td class='line'>164</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return new WebDAVCode&lt;LockResult>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>165</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>166</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public LockResult get() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>167</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return refresh(token);</pre></td>
    </tr>
    <tr>
      <td class='line'>168</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>169</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.evalNoEx();</pre></td>
    </tr>
    <tr>
      <td class='line'>170</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * If the resource is currently locked, and the tokenId  matches the current
   * one, unlock the resource.
   *
   * @param tokenId lock token
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>178</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>179</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public void unlock(final String tokenId) throws NotAuthorizedException,</pre></td>
    </tr>
    <tr>
      <td class='line'>180</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      PreConditionFailedException {</pre></td>
    </tr>
    <tr>
      <td class='line'>181</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    new WebDAVCode&lt;Object>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>182</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>183</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public void run() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>184</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        service.locking.unlock(tokenId);</pre></td>
    </tr>
    <tr>
      <td class='line'>185</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>186</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.evalNoEx();</pre></td>
    </tr>
    <tr>
      <td class='line'>187</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Get the active lock for the current resource.
   * @return - the current lock if the resource is locked, or null
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>193</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>194</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  public LockToken getCurrentLock() {</pre></td>
    </tr>
    <tr>
      <td class='line'>195</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return new WebDAVCode&lt;LockToken>(this) {</pre></td>
    </tr>
    <tr>
      <td class='line'>196</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>197</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      public LockToken get() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>198</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return getCurrentActiveLock();</pre></td>
    </tr>
    <tr>
      <td class='line'>199</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      }</pre></td>
    </tr>
    <tr>
      <td class='line'>200</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }.evalNoEx();</pre></td>
    </tr>
    <tr>
      <td class='line'>201</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Delete document or folder.
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>207</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void del() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>208</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    service.delete(meta.db, meta.path);</pre></td>
    </tr>
    <tr>
      <td class='line'>209</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Rename document or folder.
   * @param n new name
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>216</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void rename(final String n) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>217</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    service.rename(meta.db, meta.path, n);</pre></td>
    </tr>
    <tr>
      <td class='line'>218</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Copy folder to the root, creating a new database.
   * @param n new name of the folder (database)
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>225</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  protected abstract void copyToRoot(final String n) throws IOException;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Copy folder to another folder.
   * @param f target folder
   * @param n new name of the folder
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>233</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  protected abstract void copyTo(final WebDAVFolder f, final String n) throws IOException;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Move folder to the root, creating a new database.
   * @param n new name of the folder (database)
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>240</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  void moveToRoot(final String n) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>241</td><td>&nbsp;</td>
      <td><pre class='comment'>    // folder is moved to the root: create new database with it</pre></td>
    </tr>
    <tr>
      <td class='line'>242</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    copyToRoot(n);</pre></td>
    </tr>
    <tr>
      <td class='line'>243</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    del();</pre></td>
    </tr>
    <tr>
      <td class='line'>244</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Move folder to another folder.
   * @param f target folder
   * @param n new name of the folder
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>252</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private void moveTo(final WebDAVFolder f, final String n) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>253</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    if(f.meta.db.equals(meta.db)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>254</td><td>&nbsp;</td>
      <td><pre class='comment'>      // folder is moved to a folder in the same database</pre></td>
    </tr>
    <tr>
      <td class='line'>255</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      rename(f.meta.path + SEP + n);</pre></td>
    </tr>
    <tr>
      <td class='line'>256</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    } else {</pre></td>
    </tr>
    <tr>
      <td class='line'>257</td><td>&nbsp;</td>
      <td><pre class='comment'>      // folder is moved to a folder in another database</pre></td>
    </tr>
    <tr>
      <td class='line'>258</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      copyTo(f, n);</pre></td>
    </tr>
    <tr>
      <td class='line'>259</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      del();</pre></td>
    </tr>
    <tr>
      <td class='line'>260</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>261</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Lock the current resource.
   * @param timeout lock timeout
   * @param lockInfo lock info
   * @return lock result
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>269</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private LockResult lockResource(final LockTimeout timeout, final LockInfo lockInfo) {</pre></td>
    </tr>
    <tr>
      <td class='line'>270</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    try {</pre></td>
    </tr>
    <tr>
      <td class='line'>271</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final String tokenId = service.locking.lock(</pre></td>
    </tr>
    <tr>
      <td class='line'>272</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        meta.db,</pre></td>
    </tr>
    <tr>
      <td class='line'>273</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        meta.path,</pre></td>
    </tr>
    <tr>
      <td class='line'>274</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockInfo.scope.name().toLowerCase(Locale.ENGLISH),</pre></td>
    </tr>
    <tr>
      <td class='line'>275</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockInfo.type.name().toLowerCase(Locale.ENGLISH),</pre></td>
    </tr>
    <tr>
      <td class='line'>276</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockInfo.depth.name().toLowerCase(Locale.ENGLISH),</pre></td>
    </tr>
    <tr>
      <td class='line'>277</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockInfo.lockedByUser,</pre></td>
    </tr>
    <tr>
      <td class='line'>278</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        timeout.getSeconds()</pre></td>
    </tr>
    <tr>
      <td class='line'>279</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      );</pre></td>
    </tr>
    <tr>
      <td class='line'>280</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      return success(new LockToken(tokenId, lockInfo, timeout));</pre></td>
    </tr>
    <tr>
      <td class='line'>281</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    } catch(final IOException ex) {</pre></td>
    </tr>
    <tr>
      <td class='line'>282</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      return failed(FailureReason.ALREADY_LOCKED);</pre></td>
    </tr>
    <tr>
      <td class='line'>283</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>284</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Get the active lock on the current resource.
   * @return the token of the active lock or {@code null} if resource is not locked
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>291</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private LockToken getCurrentActiveLock() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>292</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String lockInfoStr = service.locking.lock(meta.db, meta.path);</pre></td>
    </tr>
    <tr>
      <td class='line'>293</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return lockInfoStr == null ? null : parseLockInfo(lockInfoStr);</pre></td>
    </tr>
    <tr>
      <td class='line'>294</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Renew a lock with the given token.
   * @param token lock token
   * @return lock result
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>302</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private LockResult refresh(final String token) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>303</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    service.locking.refreshLock(token);</pre></td>
    </tr>
    <tr>
      <td class='line'>304</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final String lockInfoStr = service.locking.lock(token);</pre></td>
    </tr>
    <tr>
      <td class='line'>305</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    final LockToken lockToken = lockInfoStr == null ? null : parseLockInfo(lockInfoStr);</pre></td>
    </tr>
    <tr>
      <td class='line'>306</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    return lockToken == null ? failed(FailureReason.ALREADY_LOCKED) : success(lockToken);</pre></td>
    </tr>
    <tr>
      <td class='line'>307</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>  /**
   * Parse the lock info.
   * @param lockInfo lock info as a string
   * @return parsed lock info bean
   * @throws IOException I/O exception
   */</div><span>  /*...*/</span></td>
    </tr>
    <tr>
      <td class='line'>315</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private static LockToken parseLockInfo(final String lockInfo) throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>316</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    try {</pre></td>
    </tr>
    <tr>
      <td class='line'>317</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final XMLReader reader = XMLReaderFactory.createXMLReader();</pre></td>
    </tr>
    <tr>
      <td class='line'>318</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final LockTokenSaxHandler handler = new LockTokenSaxHandler();</pre></td>
    </tr>
    <tr>
      <td class='line'>319</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      reader.setContentHandler(handler);</pre></td>
    </tr>
    <tr>
      <td class='line'>320</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      reader.parse(new InputSource(new StringReader(lockInfo)));</pre></td>
    </tr>
    <tr>
      <td class='line'>321</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      return handler.lockToken;</pre></td>
    </tr>
    <tr>
      <td class='line'>322</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    } catch(final SAXException ex) {</pre></td>
    </tr>
    <tr>
      <td class='line'>323</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      Util.errln("Error while parsing lock info: %", ex);</pre></td>
    </tr>
    <tr>
      <td class='line'>324</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      return null;</pre></td>
    </tr>
    <tr>
      <td class='line'>325</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>326</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>328</td><td>&nbsp;</td>
      <td><pre class='comment'>  /** SAX handler for lock token. */</pre></td>
    </tr>
    <tr>
      <td class='line'>329</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  private static final class LockTokenSaxHandler extends DefaultHandler {</pre></td>
    </tr>
    <tr>
      <td class='line'>330</td><td>&nbsp;</td>
      <td><pre class='comment'>    /** Parsed lock token. */</pre></td>
    </tr>
    <tr>
      <td class='line'>331</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private final LockToken lockToken = new LockToken(null, new LockInfo(), null);</pre></td>
    </tr>
    <tr>
      <td class='line'>332</td><td>&nbsp;</td>
      <td><pre class='comment'>    /** Current element name. */</pre></td>
    </tr>
    <tr>
      <td class='line'>333</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private String elementName;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>335</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>336</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public void startElement(final String uri, final String localName, final String name,</pre></td>
    </tr>
    <tr>
      <td class='line'>337</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        final Attributes attributes) throws SAXException {</pre></td>
    </tr>
    <tr>
      <td class='line'>338</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      elementName = localName;</pre></td>
    </tr>
    <tr>
      <td class='line'>339</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      super.startElement(uri, localName, name, attributes);</pre></td>
    </tr>
    <tr>
      <td class='line'>340</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>342</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>343</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public void endElement(final String uri, final String localName, final String qName)</pre></td>
    </tr>
    <tr>
      <td class='line'>344</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        throws SAXException {</pre></td>
    </tr>
    <tr>
      <td class='line'>345</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      elementName = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>346</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      super.endElement(uri, localName, qName);</pre></td>
    </tr>
    <tr>
      <td class='line'>347</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>349</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    @Override</pre></td>
    </tr>
    <tr>
      <td class='line'>350</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public void characters(final char[] ch, final int start, final int length) {</pre></td>
    </tr>
    <tr>
      <td class='line'>351</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      final String v = String.valueOf(ch, start, length);</pre></td>
    </tr>
    <tr>
      <td class='line'>352</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      if("token".equals(elementName))</pre></td>
    </tr>
    <tr>
      <td class='line'>353</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockToken.tokenId = v;</pre></td>
    </tr>
    <tr>
      <td class='line'>354</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      else if("scope".equals(elementName))</pre></td>
    </tr>
    <tr>
      <td class='line'>355</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockToken.info.scope = LockScope.valueOf(v.toUpperCase(Locale.ENGLISH));</pre></td>
    </tr>
    <tr>
      <td class='line'>356</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      else if("type".equals(elementName))</pre></td>
    </tr>
    <tr>
      <td class='line'>357</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockToken.info.type = LockType.valueOf(v.toUpperCase(Locale.ENGLISH));</pre></td>
    </tr>
    <tr>
      <td class='line'>358</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      else if("depth".equals(elementName))</pre></td>
    </tr>
    <tr>
      <td class='line'>359</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockToken.info.depth = LockDepth.valueOf(v.toUpperCase(Locale.ENGLISH));</pre></td>
    </tr>
    <tr>
      <td class='line'>360</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      else if("owner".equals(elementName))</pre></td>
    </tr>
    <tr>
      <td class='line'>361</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockToken.info.lockedByUser = v;</pre></td>
    </tr>
    <tr>
      <td class='line'>362</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>      else if("timeout".equals(elementName))</pre></td>
    </tr>
    <tr>
      <td class='line'>363</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        lockToken.timeout = LockTimeout.parseTimeout(v);</pre></td>
    </tr>
    <tr>
      <td class='line'>364</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>365</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>  }</pre></td>
    </tr>
    <tr>
      <td class='line'>366</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>}</pre></td>
    </tr>
  </table>
</body>
</html>
